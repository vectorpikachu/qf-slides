<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Topics in Quantitative Finance, Summer 2025 – qf-slides</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-bb03f0ebc888f6eea39ad7b9fbf3907c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">qf-slides</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../NSD_Lec01-FinancialEngineering_Summer2025.html"> 
<span class="menu-text">Lecture 01</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../NSD_Lec02-StochCal_Summer2025.html"> 
<span class="menu-text">Lecture 02</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../NSD_Lec03-BlackMertonScholes-1_Summer2025.html"> 
<span class="menu-text">Lecture 03</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../NSD_Lec04_Summer2025/NSD_Lec04-BlackMertonScholes-2_Summer2025.html"> 
<span class="menu-text">Lecture 04</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../NSD_Lec05_Summer2025/NSD_Lec05-Volatility_Summer2025.html" aria-current="page"> 
<span class="menu-text">Lecture 05</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lecture-5-volatility-and-volatility-linked-derivatives" id="toc-lecture-5-volatility-and-volatility-linked-derivatives" class="nav-link active" data-scroll-target="#lecture-5-volatility-and-volatility-linked-derivatives">Lecture 5: Volatility and volatility-linked derivatives</a></li>
  <li><a href="#agenda" id="toc-agenda" class="nav-link" data-scroll-target="#agenda">Agenda</a></li>
  <li><a href="#what-is-volatility" id="toc-what-is-volatility" class="nav-link" data-scroll-target="#what-is-volatility">What is volatility?</a></li>
  <li><a href="#why-is-volatility-important" id="toc-why-is-volatility-important" class="nav-link" data-scroll-target="#why-is-volatility-important">Why is volatility important?</a></li>
  <li><a href="#volatilities" id="toc-volatilities" class="nav-link" data-scroll-target="#volatilities">Volatilities</a></li>
  <li><a href="#historical-volatility" id="toc-historical-volatility" class="nav-link" data-scroll-target="#historical-volatility">Historical volatility</a></li>
  <li><a href="#example-of-historical-volatility" id="toc-example-of-historical-volatility" class="nav-link" data-scroll-target="#example-of-historical-volatility">Example of historical volatility</a>
  <ul class="collapse">
  <li><a href="#note" id="toc-note" class="nav-link" data-scroll-target="#note">Note</a></li>
  <li><a href="#exponetially-weighted-moving-average-ewma" id="toc-exponetially-weighted-moving-average-ewma" class="nav-link" data-scroll-target="#exponetially-weighted-moving-average-ewma">Exponetially weighted moving average (EWMA)</a></li>
  </ul></li>
  <li><a href="#now-lets-dirty-our-hands" id="toc-now-lets-dirty-our-hands" class="nav-link" data-scroll-target="#now-lets-dirty-our-hands">Now let’s dirty our hands …</a>
  <ul class="collapse">
  <li><a href="#tips-you-may-skip-the-next-5-cells-if-you-encounter-an-error." id="toc-tips-you-may-skip-the-next-5-cells-if-you-encounter-an-error." class="nav-link" data-scroll-target="#tips-you-may-skip-the-next-5-cells-if-you-encounter-an-error.">Tips: You may skip the next 5 cells if you encounter an error.</a></li>
  <li><a href="#you-may-start-from-here." id="toc-you-may-start-from-here." class="nav-link" data-scroll-target="#you-may-start-from-here.">You may start from here.</a></li>
  </ul></li>
  <li><a href="#volatility-estimation-using-ohlc" id="toc-volatility-estimation-using-ohlc" class="nav-link" data-scroll-target="#volatility-estimation-using-ohlc">Volatility estimation using OHLC</a></li>
  <li><a href="#implied-volatility" id="toc-implied-volatility" class="nav-link" data-scroll-target="#implied-volatility">Implied volatility</a></li>
  <li><a href="#why-implied-volatility-rather-than-the-price-itself" id="toc-why-implied-volatility-rather-than-the-price-itself" class="nav-link" data-scroll-target="#why-implied-volatility-rather-than-the-price-itself">Why implied volatility rather than the price itself?</a></li>
  <li><a href="#a-practical-tip-for-fetching-risk-free-and-dividend-rates" id="toc-a-practical-tip-for-fetching-risk-free-and-dividend-rates" class="nav-link" data-scroll-target="#a-practical-tip-for-fetching-risk-free-and-dividend-rates">A practical tip for fetching risk free and dividend rates</a></li>
  <li><a href="#example---implied-volatilities-of-options-on-spx" id="toc-example---implied-volatilities-of-options-on-spx" class="nav-link" data-scroll-target="#example---implied-volatilities-of-options-on-spx">Example - Implied volatilities of options on SPX</a>
  <ul class="collapse">
  <li><a href="#tips-you-may-skip-the-next-12-cells-if-you-encounter-an-error." id="toc-tips-you-may-skip-the-next-12-cells-if-you-encounter-an-error." class="nav-link" data-scroll-target="#tips-you-may-skip-the-next-12-cells-if-you-encounter-an-error.">Tips: You may skip the next 12 cells if you encounter an error.</a></li>
  <li><a href="#you-may-start-from-here" id="toc-you-may-start-from-here" class="nav-link" data-scroll-target="#you-may-start-from-here">You may start from here</a></li>
  <li><a href="#create-python-class-optionanalytics" id="toc-create-python-class-optionanalytics" class="nav-link" data-scroll-target="#create-python-class-optionanalytics">Create <code>python</code> class <code>OptionAnalytics</code></a></li>
  </ul></li>
  <li><a href="#a-shorter-time-to-expiry-option-on-spx" id="toc-a-shorter-time-to-expiry-option-on-spx" class="nav-link" data-scroll-target="#a-shorter-time-to-expiry-option-on-spx">A shorter time to expiry option on SPX</a>
  <ul class="collapse">
  <li><a href="#tips-you-may-skip-this-part-if-you-encounter-an-error." id="toc-tips-you-may-skip-this-part-if-you-encounter-an-error." class="nav-link" data-scroll-target="#tips-you-may-skip-this-part-if-you-encounter-an-error.">Tips: You may skip this part if you encounter an error.</a></li>
  <li><a href="#you-may-start-from-here.-1" id="toc-you-may-start-from-here.-1" class="nav-link" data-scroll-target="#you-may-start-from-here.-1">You may start from here.</a></li>
  </ul></li>
  <li><a href="#gpr-fit-for-spx-implied-volatility-curve" id="toc-gpr-fit-for-spx-implied-volatility-curve" class="nav-link" data-scroll-target="#gpr-fit-for-spx-implied-volatility-curve">GPR fit for SPX implied volatility curve</a>
  <ul class="collapse">
  <li><a href="#fine-tune-hyperparameters-by-mle" id="toc-fine-tune-hyperparameters-by-mle" class="nav-link" data-scroll-target="#fine-tune-hyperparameters-by-mle">Fine tune hyperparameters by MLE</a></li>
  </ul></li>
  <li><a href="#what-is-vix" id="toc-what-is-vix" class="nav-link" data-scroll-target="#what-is-vix">What is VIX?</a></li>
  <li><a href="#volatility-indices-published-by-cboe" id="toc-volatility-indices-published-by-cboe" class="nav-link" data-scroll-target="#volatility-indices-published-by-cboe">Volatility indices published by CBOE</a>
  <ul class="collapse">
  <li><a href="#note-1" id="toc-note-1" class="nav-link" data-scroll-target="#note-1">Note</a></li>
  </ul></li>
  <li><a href="#formula-of-finanical-engineering" id="toc-formula-of-finanical-engineering" class="nav-link" data-scroll-target="#formula-of-finanical-engineering">“Formula of finanical engineering”</a></li>
  <li><a href="#example---log-contract" id="toc-example---log-contract" class="nav-link" data-scroll-target="#example---log-contract">Example - log contract</a>
  <ul class="collapse">
  <li><a href="#note-2" id="toc-note-2" class="nav-link" data-scroll-target="#note-2">Note</a></li>
  </ul></li>
  <li><a href="#how-is-vix-calculated" id="toc-how-is-vix-calculated" class="nav-link" data-scroll-target="#how-is-vix-calculated">How is VIX calculated?</a>
  <ul class="collapse">
  <li><a href="#download-vix-data-from-yfinance" id="toc-download-vix-data-from-yfinance" class="nav-link" data-scroll-target="#download-vix-data-from-yfinance">Download VIX data from <code>yfinance</code></a></li>
  <li><a href="#you-may-skip-this-part-if-you-encounter-an-error." id="toc-you-may-skip-this-part-if-you-encounter-an-error." class="nav-link" data-scroll-target="#you-may-skip-this-part-if-you-encounter-an-error.">You may skip this part if you encounter an error.</a></li>
  </ul></li>
  <li><a href="#volatility-derivatives" id="toc-volatility-derivatives" class="nav-link" data-scroll-target="#volatility-derivatives">Volatility derivatives</a></li>
  <li><a href="#variance-swap" id="toc-variance-swap" class="nav-link" data-scroll-target="#variance-swap">Variance swap</a></li>
  <li><a href="#volatility-swap" id="toc-volatility-swap" class="nav-link" data-scroll-target="#volatility-swap">Volatility swap</a></li>
  <li><a href="#calculating-volatility-swap-fair-strike-from-mgf" id="toc-calculating-volatility-swap-fair-strike-from-mgf" class="nav-link" data-scroll-target="#calculating-volatility-swap-fair-strike-from-mgf">Calculating volatility swap fair strike from MGF</a></li>
  <li><a href="#vix-futures" id="toc-vix-futures" class="nav-link" data-scroll-target="#vix-futures">VIX futures</a></li>
  <li><a href="#vix-option" id="toc-vix-option" class="nav-link" data-scroll-target="#vix-option">VIX option</a></li>
  <li><a href="#a-look-at-the-vix-option-chain-from-yahoo-finance" id="toc-a-look-at-the-vix-option-chain-from-yahoo-finance" class="nav-link" data-scroll-target="#a-look-at-the-vix-option-chain-from-yahoo-finance">A look at the VIX option chain from Yahoo Finance</a>
  <ul class="collapse">
  <li><a href="#you-may-skip-the-next-5-cells-if-you-encounter-an-error." id="toc-you-may-skip-the-next-5-cells-if-you-encounter-an-error." class="nav-link" data-scroll-target="#you-may-skip-the-next-5-cells-if-you-encounter-an-error.">You may skip the next 5 cells if you encounter an error.</a></li>
  <li><a href="#you-may-start-from-here.-2" id="toc-you-may-start-from-here.-2" class="nav-link" data-scroll-target="#you-may-start-from-here.-2">You may start from here.</a></li>
  </ul></li>
  <li><a href="#gpr-fit-for-vix-option-implied-volatility-curve" id="toc-gpr-fit-for-vix-option-implied-volatility-curve" class="nav-link" data-scroll-target="#gpr-fit-for-vix-option-implied-volatility-curve">GPR fit for VIX option implied volatility curve</a></li>
  <li><a href="#appendix-optional" id="toc-appendix-optional" class="nav-link" data-scroll-target="#appendix-optional">Appendix (Optional)</a></li>
  <li><a href="#volatility-estimation-using-high-frequency-data" id="toc-volatility-estimation-using-high-frequency-data" class="nav-link" data-scroll-target="#volatility-estimation-using-high-frequency-data">Volatility estimation using high frequency data</a></li>
  <li><a href="#realized-variance" id="toc-realized-variance" class="nav-link" data-scroll-target="#realized-variance">Realized variance</a>
  <ul class="collapse">
  <li><a href="#technical-notes" id="toc-technical-notes" class="nav-link" data-scroll-target="#technical-notes">Technical notes</a></li>
  <li><a href="#assumption" id="toc-assumption" class="nav-link" data-scroll-target="#assumption">Assumption</a></li>
  </ul></li>
  <li><a href="#integrated-variance-or-quadratic-variation" id="toc-integrated-variance-or-quadratic-variation" class="nav-link" data-scroll-target="#integrated-variance-or-quadratic-variation">Integrated variance or quadratic variation</a>
  <ul class="collapse">
  <li><a href="#microstructure-noise" id="toc-microstructure-noise" class="nav-link" data-scroll-target="#microstructure-noise">Microstructure noise</a></li>
  <li><a href="#asymptotic-result" id="toc-asymptotic-result" class="nav-link" data-scroll-target="#asymptotic-result">Asymptotic result</a></li>
  <li><a href="#the-conventional-solution" id="toc-the-conventional-solution" class="nav-link" data-scroll-target="#the-conventional-solution">The conventional solution</a></li>
  <li><a href="#subsampling" id="toc-subsampling" class="nav-link" data-scroll-target="#subsampling">Subsampling</a></li>
  <li><a href="#boosting-rv-estimator" id="toc-boosting-rv-estimator" class="nav-link" data-scroll-target="#boosting-rv-estimator">Boosting RV estimator</a></li>
  <li><a href="#the-zma-estimator" id="toc-the-zma-estimator" class="nav-link" data-scroll-target="#the-zma-estimator">The ZMA estimator</a></li>
  <li><a href="#the-zhou-estimator" id="toc-the-zhou-estimator" class="nav-link" data-scroll-target="#the-zhou-estimator">The Zhou estimator</a></li>
  </ul></li>
  <li><a href="#realized-library" id="toc-realized-library" class="nav-link" data-scroll-target="#realized-library">Realized library</a></li>
  <li><a href="#spx-realized-variance" id="toc-spx-realized-variance" class="nav-link" data-scroll-target="#spx-realized-variance">SPX realized variance</a></li>
  <li><a href="#the-corsi-har-rv-forecast" id="toc-the-corsi-har-rv-forecast" class="nav-link" data-scroll-target="#the-corsi-har-rv-forecast">The Corsi HAR-RV forecast</a>
  <ul class="collapse">
  <li><a href="#note-9" id="toc-note-9" class="nav-link" data-scroll-target="#note-9">Note</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Topics in Quantitative Finance, Summer 2025</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="lecture-5-volatility-and-volatility-linked-derivatives" class="level2">
<h2 class="anchored" data-anchor-id="lecture-5-volatility-and-volatility-linked-derivatives">Lecture 5: Volatility and volatility-linked derivatives</h2>
<p><br> <br></p>
<center>
<font size="5," color="darkblue"> Tai-Ho Wang (王 太和)</font>
</center>
<p><span class="math display">\[
\newcommand{\bea}{\begin{eqnarray}}
\newcommand{\eea}{\end{eqnarray}}
\newcommand{\supp}{\mathrm{supp}}
\newcommand{\F}{\mathcal{F} }
\newcommand{\cF}{\mathcal{F} }
\newcommand{\E}{\mathbb{E} }
\newcommand{\Eof}[1]{\mathbb{E}\left[ #1 \right]}
\newcommand{\Etof}[1]{\mathbb{E}_t\left[ #1 \right]}
\def\Cov{{ \text{Cov} }}
\def\ES{{ \text{ES} }}
\def\Var{{ \text{Var} }}
\def\VaR{{ \text{VaR} }}
\def\sd{{ \text{sd} }}
\def\corr{{ \text{corr} }}
\newcommand{\1}{\mathbf{1} }
\newcommand{\p}{\partial}
\newcommand{\PP}{\mathbb{P} }
\newcommand{\Pof}[1]{\mathbb{P}\left[ #1 \right]}
\newcommand{\QQ}{\mathbb{Q} }
\renewcommand{\R}{\mathbb{R} }
\newcommand{\DD}{\mathbb{D} }
\newcommand{\HH}{\mathbb{H} }
\newcommand{\spn}{\mathrm{span} }
\newcommand{\cov}{\mathrm{cov} }
\newcommand{\HS}{\mathcal{L}_{\mathrm{HS}} }
\newcommand{\Hess}{\mathrm{Hess} }
\newcommand{\trace}{\mathrm{trace} }
\newcommand{\LL}{\mathcal{L} }
\newcommand{\s}{\mathcal{S} }
\newcommand{\ee}{\mathcal{E} }
\newcommand{\ff}{\mathcal{F} }
\newcommand{\hh}{\mathcal{H} }
\newcommand{\bb}{\mathcal{B} }
\newcommand{\dd}{\mathcal{D} }
\newcommand{\g}{\mathcal{G} }
\newcommand{\half}{\frac{1}{2} }
\newcommand{\T}{\mathcal{T} }
\newcommand{\bit}{\begin{itemize}}
\newcommand{\eit}{\end{itemize}}
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\tr}{\text{tr}}
\renewcommand{\angl}[1]{\langle #1 \rangle}
\]</span></p>
</section>
<section id="agenda" class="level2">
<h2 class="anchored" data-anchor-id="agenda">Agenda</h2>
<ul>
<li>Volatility and its various estimators
<ul>
<li>Historical volatility</li>
<li>Implied volatility</li>
<li>Realized variance</li>
<li>VIX</li>
</ul></li>
<li>Implied volatility
<ul>
<li>Estimating discount factor and dividend rates by put-call parity</li>
<li>GPR fit of implied volatilities</li>
</ul></li>
<li>Volatility indices published by CBOE</li>
<li>Volatility linked derivatives
<ul>
<li>VIX option</li>
</ul></li>
<li>Appendix (Optional)
<ul>
<li>Realized variance from high frequency data</li>
<li>The Corsi HAR-RV forecast</li>
</ul></li>
</ul>
</section>
<section id="what-is-volatility" class="level2">
<h2 class="anchored" data-anchor-id="what-is-volatility">What is volatility?</h2>
<p>From the <a href="https://en.wikipedia.org/wiki/Volatility_(finance)">Wikipage</a>:</p>
<blockquote class="blockquote">
<p>In finance, volatility (symbol <span class="math inline">\(\sigma\)</span>) is the degree of variation of a trading price series over time as measured by the standard deviation of logarithmic returns.</p>
<ul>
<li>Historic volatility measures a time series of past market prices.</li>
<li>Implied volatility looks forward in time, being derived from the market price of a market-traded derivative (in particular, an option).</li>
<li>Realized variance estimates the integrated variance or quadratic variation by using high frequency data.</li>
</ul>
</blockquote>
</section>
<section id="why-is-volatility-important" class="level2">
<h2 class="anchored" data-anchor-id="why-is-volatility-important">Why is volatility important?</h2>
<p>From the same <a href="https://en.wikipedia.org/wiki/Volatility_(finance)">Wikipage</a>:</p>
<blockquote class="blockquote">
<p>Investors care about volatility for at least the following reasons:</p>
<ul>
<li><p>The wider the swings in an investment’s price, the harder emotionally it is to not worry;</p></li>
<li><p>Price volatility of a trading instrument can define position sizing in a portfolio;</p></li>
<li><p>When certain cash flows from selling a security are needed at a specific future date, higher volatility means a greater chance of a shortfall;</p></li>
<li><p>Higher volatility of returns while saving for retirement results in a wider distribution of possible final portfolio values;</p></li>
<li><p>Higher volatility of return when retired gives withdrawals a larger permanent impact on the portfolio’s value;</p></li>
<li><p>Price volatility presents opportunities to buy assets cheaply and sell when overpriced;</p></li>
<li><p><font color="blue"> Portfolio volatility has a negative impact on the compound annual growth rate (CAGR) of that portfolio </font></p></li>
<li><p>Volatility affects pricing of options, being a parameter of the Black–Scholes model.</p></li>
</ul>
</blockquote>
<p>In today’s markets, it is also possible to trade volatility directly, through the use of derivative securities such as options and variance swaps.</p>
</section>
<section id="volatilities" class="level2">
<h2 class="anchored" data-anchor-id="volatilities">Volatilities</h2>
<p>Volatiltiy of a financial asset in its most prelimanry form is defined as the (conditional) standard deviation of its log return. In practice, there exist various notions of “volatility” that are commonly used including</p>
<ul>
<li>Historical volatility</li>
<li>Realized and integrated variance/volatility</li>
<li>Implied volatility</li>
<li>Instantaneous volatility</li>
</ul>
<p>and methods of inferring these volatilities respectively from</p>
<ul>
<li>Daily or high-frequency time series data of the underlying</li>
<li>Price series of variance swap</li>
<li>Prices of liquidly traded vanilla options</li>
</ul>
</section>
<section id="historical-volatility" class="level2">
<h2 class="anchored" data-anchor-id="historical-volatility">Historical volatility</h2>
<p>Historical volatility uses, say daily, price series to calculate the sample conditional standard deviation of log returns in rolling time windows of a prespecified width.</p>
</section>
<section id="example-of-historical-volatility" class="level2">
<h2 class="anchored" data-anchor-id="example-of-historical-volatility">Example of historical volatility</h2>
<p>Now let’s calculate the volatility of S&amp;P500 using 25-day rolling time windows.</p>
<p>One can calculate the volatiltiy series of the input price series <span class="math inline">\(S_t\)</span>, <span class="math inline">\(1 \leq t \leq T\)</span>, by the following formula</p>
<p><span class="math display">\[
\sigma_t = \sqrt{\frac N{n-2}\sum_{i=1}^{n-1} (r_i - \bar r)^2}, \quad \text{ for } n \leq t \leq T,
\]</span></p>
<p>where</p>
<span class="math display">\[\begin{aligned}
r_i &amp;= \ln S_{t + i} - \ln S_{t + i - 1}, \quad \text{for } 1 \leq i \leq n - 1, \\
\bar{r} &amp;= \frac{1}{n-1} \sum_{i=1}^{n-1} r_i.
\end{aligned}\]</span>
<section id="note" class="level3">
<h3 class="anchored" data-anchor-id="note">Note</h3>
<ul>
<li><span class="math inline">\(n\)</span> denotes the width (number of days) of rolling window</li>
<li><span class="math inline">\(N\)</span> denotes the number of days in a year, thus <span class="math inline">\(\sqrt N\)</span> is the annualizing factor</li>
<li>The first <span class="math inline">\(n-1\)</span> points in the output volatility series appear as NA, for an obvious reason.</li>
</ul>
</section>
<section id="exponetially-weighted-moving-average-ewma" class="level3">
<h3 class="anchored" data-anchor-id="exponetially-weighted-moving-average-ewma">Exponetially weighted moving average (EWMA)</h3>
<p>An alternative to calculate historical volatility is the <em>exponentially weighted moving average</em> method.</p>
<p><span class="math display">\[
\sigma_t = \sqrt{N(1 - \lambda)\sum_{i=1}^{\infty} \lambda^i (r_{t - i} - \bar r)^2}, \quad \text{ for } n \leq t \leq T,
\]</span></p>
<p>for some <span class="math inline">\(\lambda \in (0, 1)\)</span>.</p>
</section>
</section>
<section id="now-lets-dirty-our-hands" class="level2">
<h2 class="anchored" data-anchor-id="now-lets-dirty-our-hands">Now let’s dirty our hands …</h2>
<div id="cell-9" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pip install yfinance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> exp, log, sqrt</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> ss</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="tips-you-may-skip-the-next-5-cells-if-you-encounter-an-error." class="level3">
<h3 class="anchored" data-anchor-id="tips-you-may-skip-the-next-5-cells-if-you-encounter-an-error.">Tips: You may skip the next 5 cells if you encounter an error.</h3>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>proxy <span class="op">=</span> <span class="st">'http://127.0.0.1:7890'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'HTTP_PROXY'</span>] <span class="op">=</span> proxy</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'HTTPS_PROXY'</span>] <span class="op">=</span> proxy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>start, end <span class="op">=</span> <span class="st">'2019-01-01'</span>, <span class="st">'2024-07-24'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># download SPX from yahoo finance</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>spx <span class="op">=</span> yf.Ticker(<span class="st">"^GSPC"</span>).history(start<span class="op">=</span>start, end<span class="op">=</span>end)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># brief look at the data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>spx.info(), spx.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first and last few rows of the data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>spx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save data, just in case</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># spx.to_csv('spx_07252022.csv')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="you-may-start-from-here." class="level3">
<h3 class="anchored" data-anchor-id="you-may-start-from-here.">You may start from here.</h3>
<div id="cell-19" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load saved data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>spx <span class="op">=</span> pd.read_csv(<span class="st">'spx_07252022.csv'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>spx.index <span class="op">=</span> spx[<span class="st">'Date'</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>spx <span class="op">=</span> spx.drop(<span class="st">'Date'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary statistics</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>spx.describe().transpose()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Open</td>
<td>895.0</td>
<td>3.586641e+03</td>
<td>6.613510e+02</td>
<td>2290.709961</td>
<td>2.980045e+03</td>
<td>3.439380e+03</td>
<td>4.213645e+03</td>
<td>4.804510e+03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">High</td>
<td>895.0</td>
<td>3.608340e+03</td>
<td>6.637349e+02</td>
<td>2300.729980</td>
<td>2.991620e+03</td>
<td>3.464860e+03</td>
<td>4.239375e+03</td>
<td>4.818620e+03</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Low</td>
<td>895.0</td>
<td>3.562902e+03</td>
<td>6.583530e+02</td>
<td>2191.860107</td>
<td>2.963575e+03</td>
<td>3.419930e+03</td>
<td>4.192340e+03</td>
<td>4.780040e+03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Close</td>
<td>895.0</td>
<td>3.587314e+03</td>
<td>6.608265e+02</td>
<td>2237.399902</td>
<td>2.978570e+03</td>
<td>3.443120e+03</td>
<td>4.209795e+03</td>
<td>4.796560e+03</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Adj Close</td>
<td>895.0</td>
<td>3.587314e+03</td>
<td>6.608265e+02</td>
<td>2237.399902</td>
<td>2.978570e+03</td>
<td>3.443120e+03</td>
<td>4.209795e+03</td>
<td>4.796560e+03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Volume</td>
<td>895.0</td>
<td>4.069480e+09</td>
<td>1.168092e+09</td>
<td>0.000000</td>
<td>3.337885e+09</td>
<td>3.778890e+09</td>
<td>4.548675e+09</td>
<td>9.878040e+09</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot spx adjusted close</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>spx[<span class="st">'Close'</span>].plot()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'SPX'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>plt.grid()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># log return of spx </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> log(spx[<span class="st">'Close'</span>]).diff()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># historical volatility in this period</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>vol <span class="op">=</span> r.std()<span class="op">*</span>sqrt(<span class="dv">252</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>r, r.mean(), vol, <span class="bu">type</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(Date
 2019-01-02         NaN
 2019-01-03   -0.025068
 2019-01-04    0.033759
 2019-01-07    0.006986
 2019-01-08    0.009649
                 ...   
 2022-07-15    0.019019
 2022-07-18   -0.008399
 2022-07-19    0.027254
 2022-07-20    0.005878
 2022-07-21    0.009813
 Name: Close, Length: 895, dtype: float64,
 0.0005209587220526575,
 0.22945020327258875,
 pandas.core.series.Series)</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot log return</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>r.plot(lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'SPX log return'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>plt.grid()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>r.iloc[<span class="dv">0</span>:<span class="dv">10</span>], r.iloc[<span class="op">-</span><span class="dv">10</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>(Date
 2019-01-02         NaN
 2019-01-03   -0.025068
 2019-01-04    0.033759
 2019-01-07    0.006986
 2019-01-08    0.009649
 2019-01-09    0.004090
 2019-01-10    0.004508
 2019-01-11   -0.000146
 2019-01-14   -0.005271
 2019-01-15    0.010665
 Name: Close, dtype: float64,
 Date
 2022-07-08   -0.000831
 2022-07-11   -0.011594
 2022-07-12   -0.009287
 2022-07-13   -0.004467
 2022-07-14   -0.003003
 2022-07-15    0.019019
 2022-07-18   -0.008399
 2022-07-19    0.027254
 2022-07-20    0.005878
 2022-07-21    0.009813
 Name: Close, dtype: float64)</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># n: rwidth of rolling window</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># N: annualizing factor</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> volatility(data, n<span class="op">=</span><span class="dv">10</span>, N<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.Series(data)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> [np.nan <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data)<span class="op">-</span>n):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        vol <span class="op">+=</span> [data.iloc[i:(i<span class="op">+</span>n)].std()<span class="op">*</span>sqrt(N)]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({<span class="st">'volatility'</span>: vol})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>volatility(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">volatility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">890</td>
<td>0.136786</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">891</td>
<td>0.160218</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">892</td>
<td>0.160347</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">893</td>
<td>0.210679</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">894</td>
<td>0.211261</td>
</tr>
</tbody>
</table>

<p>895 rows × 1 columns</p>
</div>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>spx_vol <span class="op">=</span> volatility(r)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>spx_vol.index <span class="op">=</span> r.index</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.plot(spx_vol)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Volatility'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'SPX historical volatility'</span>, fontsize<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.grid()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># leverage effect</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>spx_scaled <span class="op">=</span> (spx <span class="op">-</span> spx.mean())<span class="op">/</span>(spx.<span class="bu">max</span>() <span class="op">-</span> spx.<span class="bu">min</span>())</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>spx_scaled[<span class="st">'Close'</span>].plot(color<span class="op">=</span><span class="st">'k'</span>, lw<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'scaled spx'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="op">-</span><span class="fl">0.6</span>, <span class="dv">1</span>])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>plt.plot(spx_vol, <span class="st">'b-.'</span>, lw<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'volatility'</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Leverage effect'</span>, fontsize<span class="op">=</span><span class="dv">24</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="volatility-estimation-using-ohlc" class="level2">
<h2 class="anchored" data-anchor-id="volatility-estimation-using-ohlc">Volatility estimation using OHLC</h2>
<ul>
<li>Parkison</li>
<li>Garman-Klass</li>
<li>Rogers-Satchell</li>
<li>Yang-Zhang</li>
</ul>
<span class="math display">\[\begin{aligned}
\sigma_P^2 &amp;= \frac{1}{4\ln2} \frac{1}{n}\sum_{i=1}^n (\ln H_i - \ln L_i)^2, \\
\sigma_{GK}^2 &amp;= \frac{1}{n} \left\{\sum_{i=1}^n \frac{1}{2}(\ln H_i - \ln L_i)^2 + (2\ln2 - 1)(\ln C_i - \ln O_i)^2 \right\}, \\
\sigma_{RS}^2 &amp;= \frac{1}{n} \sum_{i=1}^n u_i(u_i - c_i) + d_i(d_i - c_i), \\
\sigma_{YZ}^2 &amp;= \sigma_O^2 + w\sigma_C^2 + (1 - w)\sigma_P^2, \quad w = \frac{0.34}{1.34 + \frac{n+1}{n-1}}.
\end{aligned}\]</span>
<ul>
<li><span class="math inline">\(u_i = \ln H_i - \ln O_i\)</span>: daily high weighted by open,</li>
<li><span class="math inline">\(d_i = \ln L_i - \ln O_i\)</span>: daily low weighted by open</li>
<li><span class="math inline">\(o_i = \ln O_i - \ln C_{i-1}\)</span></li>
<li><span class="math inline">\(c_i = \ln C_i - \ln O_i\)</span></li>
</ul>
<p>We make the calculation of these volatilties into a python <code>class</code>.</p>
<div id="cell-31" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Volatilities:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, OHLC, n<span class="op">=</span><span class="dv">10</span>, N<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n <span class="op">=</span> n</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.N <span class="op">=</span> N</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.OHLC <span class="op">=</span> pd.DataFrame(OHLC)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.o <span class="op">=</span> <span class="va">self</span>.OHLC.Open</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.h <span class="op">=</span> <span class="va">self</span>.OHLC.High</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.l <span class="op">=</span> <span class="va">self</span>.OHLC.Low</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.c <span class="op">=</span> <span class="va">self</span>.OHLC.Close</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.r <span class="op">=</span> log(<span class="va">self</span>.OHLC[<span class="st">'Close'</span>]).diff()</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols_c <span class="op">=</span> [np.nan <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n)] </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols_p <span class="op">=</span> [np.nan <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n)]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols_gk <span class="op">=</span> [np.nan <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n)] </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols_rs <span class="op">=</span> [np.nan <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.n)] </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.r) <span class="op">-</span> <span class="va">self</span>.n):</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vols_c <span class="op">+=</span> [<span class="va">self</span>.r.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)].std()<span class="op">*</span>sqrt(<span class="va">self</span>.N)]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vols_p <span class="op">+=</span> [<span class="va">self</span>.cal_vol_p(<span class="va">self</span>.h.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.l.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)])<span class="op">*</span>sqrt(<span class="va">self</span>.N)]</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vols_gk <span class="op">+=</span> [<span class="va">self</span>.cal_vol_gk(<span class="va">self</span>.o.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.h.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.l.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.c.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)])<span class="op">*</span>sqrt(<span class="va">self</span>.N)]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vols_rs <span class="op">+=</span> [<span class="va">self</span>.cal_vol_rs(<span class="va">self</span>.o.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.h.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.l.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)], <span class="va">self</span>.c.iloc[i:(i<span class="op">+</span><span class="va">self</span>.n)])<span class="op">*</span>sqrt(<span class="va">self</span>.N)]</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols <span class="op">=</span> pd.DataFrame({<span class="st">'close'</span>: <span class="va">self</span>.vols_c, <span class="st">'parkinson'</span>: <span class="va">self</span>.vols_p, <span class="st">'garman-klass'</span>: <span class="va">self</span>.vols_gk, <span class="st">'rogers-satchell'</span>: <span class="va">self</span>.vols_rs})</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vols.index <span class="op">=</span> <span class="va">self</span>.OHLC.index</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cal_vol_p(<span class="va">self</span>, H, L):</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.sqrt(((log(H) <span class="op">-</span> log(L))<span class="op">**</span><span class="dv">2</span>).mean()<span class="op">/</span>log(<span class="dv">2</span>)<span class="op">/</span><span class="dv">4</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cal_vol_gk(<span class="va">self</span>, O, H, L, C):</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        term1 <span class="op">=</span> ((log(O) <span class="op">-</span> log(L))<span class="op">**</span><span class="dv">2</span>).mean()<span class="op">/</span><span class="dv">2</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        term2 <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>log(<span class="dv">2</span>) <span class="op">-</span> <span class="dv">1</span>)<span class="op">*</span>((log(C) <span class="op">-</span> log(O))<span class="op">**</span><span class="dv">2</span>).mean()</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.sqrt(term1 <span class="op">+</span> term2)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cal_vol_rs(<span class="va">self</span>, O, H, L, C):</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        u, d, c <span class="op">=</span> log(H) <span class="op">-</span> log(O), log(L) <span class="op">-</span> log(O), log(C) <span class="op">-</span> log(O)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.sqrt((u<span class="op">*</span>(u<span class="op">-</span>c)).mean() <span class="op">+</span> (d<span class="op">*</span>(d<span class="op">-</span>c)).mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>spx_vols <span class="op">=</span> Volatilities(spx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: total: 1.53 s
Wall time: 1.59 s</code></pre>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>spx_vols.vols[<span class="st">'garman-klass'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Date
2019-01-02         NaN
2019-01-03         NaN
2019-01-04         NaN
2019-01-07         NaN
2019-01-08         NaN
                ...   
2022-07-15    0.128716
2022-07-18    0.126178
2022-07-19    0.138915
2022-07-20    0.140416
2022-07-21    0.140299
Name: garman-klass, Length: 895, dtype: float64</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>spx_vols.vols[<span class="st">'close'</span>].plot(ls<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'Close'</span>, lw<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>spx_vols.vols[<span class="st">'parkinson'</span>].plot(lw<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Parkinson'</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>spx_vols.vols[<span class="st">'garman-klass'</span>].plot(lw<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Garman-Klass'</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>spx_vols.vols[<span class="st">'rogers-satchell'</span>].plot(lw<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Rogers-Satchell'</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>plt.grid()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>spx.tail(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Close</th>
<th data-quarto-table-cell-role="th">Adj Close</th>
<th data-quarto-table-cell-role="th">Volume</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2022-07-21</td>
<td>3955.469971</td>
<td>3999.290039</td>
<td>3927.639893</td>
<td>3998.949951</td>
<td>3998.949951</td>
<td>3586030000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="implied-volatility" class="level2">
<h2 class="anchored" data-anchor-id="implied-volatility">Implied volatility</h2>
<p>“A wrong number to a wrong formula for a correct answer.”</p>
<ul>
<li><p>In the Black-Scholes model there is a one-to-one relation between the price of the option and the volatility parameter <span class="math inline">\(\sigma\)</span>. The option prices are often quoted by stating this specific volatility, called the <em>implied volatility</em>.</p></li>
<li><p>In Black-Scholes world, the volatility is assumed constant. But in reality, options of different strike require different volatilities to match their market prices. This is called the <em>volatility smile</em>.</p></li>
<li><p>Most of the work was inspired in modeling the implied volatility.</p></li>
</ul>
</section>
<section id="why-implied-volatility-rather-than-the-price-itself" class="level2">
<h2 class="anchored" data-anchor-id="why-implied-volatility-rather-than-the-price-itself">Why implied volatility rather than the price itself?</h2>
<ul>
<li>Price of a call option is decreasing in strike and increasing in time to expiry</li>
<li>Price of a far out-of-money option is small whereas price of a far in-the-money option carries mostly the intrinsic value</li>
<li>Statistically speaking, implied volatility is a more standard quantity to infer</li>
<li>Traders trade options in terms of implied volatilities rather than their prices</li>
</ul>
</section>
<section id="a-practical-tip-for-fetching-risk-free-and-dividend-rates" class="level2">
<h2 class="anchored" data-anchor-id="a-practical-tip-for-fetching-risk-free-and-dividend-rates">A practical tip for fetching risk free and dividend rates</h2>
<p>Q: How to obtain the interest rate <span class="math inline">\(r\)</span> and dividend rate <span class="math inline">\(d\)</span> for the calculation of implied volatility?</p>
<p>A: Put-call parity.</p>
<p>Recall the Put-Call Parity for European options</p>
<p><span class="math display">\[
C - P = Se^{-dT}  - K e^{-rT} = e^{-rT} (F - K),
\]</span></p>
<p>where <span class="math inline">\(F\)</span> denotes the forward price of the underlying. Hence, if we regress <span class="math inline">\(C - P\)</span> against <span class="math inline">\(K\)</span>, the (negative) slope gives us the discount factor and the intercept gives the ex-dividend underlying.</p>
</section>
<section id="example---implied-volatilities-of-options-on-spx" class="level2">
<h2 class="anchored" data-anchor-id="example---implied-volatilities-of-options-on-spx">Example - Implied volatilities of options on SPX</h2>
<div id="cell-40" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import required modules</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime <span class="im">as</span> dt</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> exp, log, sqrt</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> ss</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="tips-you-may-skip-the-next-12-cells-if-you-encounter-an-error." class="level3">
<h3 class="anchored" data-anchor-id="tips-you-may-skip-the-next-12-cells-if-you-encounter-an-error.">Tips: You may skip the next 12 cells if you encounter an error.</h3>
<div id="cell-42" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download spx options data from yahoo finance</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>spx <span class="op">=</span> yf.Ticker(<span class="st">'^SPX'</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>spx_expiries <span class="op">=</span> spx.options</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(spx_expiries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose an expiry </span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">17</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> dt.strftime(dt.now(), <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> (dt.strptime(spx_expiries[idx], <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> dt.now()).days</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'option expiry = </span><span class="sc">{</span>spx_expiries[idx]<span class="sc">}</span><span class="ss">, today = </span><span class="sc">{</span>today<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span>day_count<span class="sc">}</span><span class="ss"> days to expiry'</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>option_chain <span class="op">=</span> spx.option_chain(spx_expiries[idx])</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>spx_calls <span class="op">=</span> option_chain.calls</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>spx_puts <span class="op">=</span> option_chain.puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>spx_calls.shape, spx_puts.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>spx_calls.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>spx_calls.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>spx_puts.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>spx_calls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up data</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remove NA's</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>spx_calls <span class="op">=</span> spx_calls.drop([<span class="st">'currency'</span>, <span class="st">'contractSize'</span>], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>spx_puts <span class="op">=</span> spx_puts.drop([<span class="st">'currency'</span>, <span class="st">'contractSize'</span>], axis<span class="op">=</span><span class="dv">1</span>).dropna()</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>spx_calls.shape, spx_puts.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>spx_calls[spx_calls[<span class="st">'lastTradeDate'</span>] <span class="op">&gt;</span> <span class="st">'2024-07'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove data point where either bid = 0 or ask = 0</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remove data that that are not traded recently</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>spx_calls <span class="op">=</span> spx_calls[(spx_calls[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (spx_calls[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">#spx_calls[spx_calls['lastTradeDate'] &gt; '2022-07']</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>spx_calls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>spx_puts <span class="op">=</span> spx_puts[(spx_puts[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (spx_puts[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">#spx_puts = spx_puts[spx_puts['lastTradeDate'] &gt; '2022-02']</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>spx_puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save data as csv</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#spx_calls.to_csv('spxcall_07252022.csv', index=False)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#spx_puts.to_csv('spxput_07252022.csv', index=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="you-may-start-from-here" class="level3">
<h3 class="anchored" data-anchor-id="you-may-start-from-here">You may start from here</h3>
<div id="cell-55" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read saved spx option data</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>spx_calls <span class="op">=</span> pd.read_csv(<span class="st">'spxcall_07252022.csv'</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>spx_puts <span class="op">=</span> pd.read_csv(<span class="st">'spxput_07252022.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-python-class-optionanalytics" class="level3">
<h3 class="anchored" data-anchor-id="create-python-class-optionanalytics">Create <code>python</code> class <code>OptionAnalytics</code></h3>
<p>Wrap everything up in a python class.</p>
<div id="cell-57" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptionAnalytics:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, option_chain, expiry, today):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.expiry <span class="op">=</span> expiry</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.today <span class="op">=</span> today</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">type</span>(today) <span class="op">==</span> datetime.datetime:</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.today <span class="op">=</span> dt.strptime(today, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calls, <span class="va">self</span>.puts <span class="op">=</span> option_chain</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ks_c <span class="op">=</span> <span class="va">self</span>.calls[<span class="st">'strike'</span>]</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cs <span class="op">=</span> (<span class="va">self</span>.calls[<span class="st">'bid'</span>] <span class="op">+</span> <span class="va">self</span>.calls[<span class="st">'ask'</span>])<span class="op">/</span><span class="dv">2</span> </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ks_p <span class="op">=</span> <span class="va">self</span>.puts[<span class="st">'strike'</span>] </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ps <span class="op">=</span> (<span class="va">self</span>.puts[<span class="st">'bid'</span>] <span class="op">+</span> <span class="va">self</span>.puts[<span class="st">'ask'</span>])<span class="op">/</span><span class="dv">2</span>         </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># strikes that are traded for both calls and puts</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ks <span class="op">=</span> np.array([])</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="va">self</span>.ks_c:</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> k <span class="kw">in</span> np.array(<span class="va">self</span>.ks_p):</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.ks <span class="op">=</span> np.concatenate([<span class="va">self</span>.ks, [k]])</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mids_call <span class="op">=</span> np.array([])</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="va">self</span>.ks:</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.calls[<span class="va">self</span>.calls[<span class="st">'strike'</span>] <span class="op">==</span> k][<span class="st">'bid'</span>]</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            bid <span class="op">=</span> <span class="va">self</span>.calls[<span class="va">self</span>.calls[<span class="st">'strike'</span>] <span class="op">==</span> k][<span class="st">'bid'</span>]</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            ask <span class="op">=</span> <span class="va">self</span>.calls[<span class="va">self</span>.calls[<span class="st">'strike'</span>] <span class="op">==</span> k][<span class="st">'ask'</span>]</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mids_call <span class="op">=</span> np.concatenate([<span class="va">self</span>.mids_call, np.array((bid <span class="op">+</span> ask)<span class="op">/</span><span class="dv">2</span>)])</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mids_put <span class="op">=</span> np.array([])</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="va">self</span>.ks:</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>            bid <span class="op">=</span> <span class="va">self</span>.puts[<span class="va">self</span>.puts[<span class="st">'strike'</span>] <span class="op">==</span> k][<span class="st">'bid'</span>]</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            ask <span class="op">=</span> <span class="va">self</span>.puts[<span class="va">self</span>.puts[<span class="st">'strike'</span>] <span class="op">==</span> k][<span class="st">'ask'</span>]</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mids_put <span class="op">=</span> np.concatenate([<span class="va">self</span>.mids_put, np.array((bid <span class="op">+</span> ask)<span class="op">/</span><span class="dv">2</span>)])</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> <span class="va">self</span>.imp_vols()</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ivs, <span class="va">self</span>.s_adj <span class="op">=</span> tmp[<span class="st">'imp_vols'</span>], tmp[<span class="st">'s_adj'</span>]</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put-call parity plot </span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_parity(<span class="va">self</span>):</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">5</span>))</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.ks, <span class="va">self</span>.mids_call <span class="op">-</span> <span class="va">self</span>.mids_put, <span class="st">'r.--'</span>)</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="vs">r'</span><span class="dv">$</span><span class="vs">C - P</span><span class="dv">$</span><span class="vs">'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="vs">r'</span><span class="dv">$</span><span class="vs">K</span><span class="dv">$</span><span class="vs">'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Expiry: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>expiry<span class="sc">}</span><span class="ss">'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_arb(<span class="va">self</span>):</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># monotonicity and convexity for option premia vs strikes</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].plot(<span class="va">self</span>.ks_c, <span class="va">self</span>.cs, <span class="st">'bo--'</span>)</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Option mid price'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Strike'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].plot(<span class="va">self</span>.ks_p, <span class="va">self</span>.ps, <span class="st">'ro--'</span>)</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Strike'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot implied vol</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_imp_vols1(<span class="va">self</span>):</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>        ivs_c <span class="op">=</span> <span class="va">self</span>.calls[<span class="st">'impliedVolatility'</span>]</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>        ivs_p <span class="op">=</span> <span class="va">self</span>.puts[<span class="st">'impliedVolatility'</span>]</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plot </span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.ks_p, ivs_p, <span class="st">'ro--'</span>, label<span class="op">=</span><span class="st">'implied vol from puts'</span>)</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.ks_c, ivs_c, <span class="st">'bo--'</span>, label<span class="op">=</span><span class="st">'implied vol from calls'</span>)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Expiration date: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>expiry<span class="sc">}</span><span class="ss">'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Strikes'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Impliied Volatilities'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>        plt.legend()<span class="op">;</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Black-Scholes formula for call</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bs_call(<span class="va">self</span>, s, K, t, sigma, r<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>        d1 <span class="op">=</span> (log(s<span class="op">/</span>K) <span class="op">+</span> r<span class="op">*</span>t)<span class="op">/</span>(sigma<span class="op">*</span>sqrt(t)) <span class="op">+</span> sigma<span class="op">*</span>sqrt(t)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> d1 <span class="op">-</span> sigma<span class="op">*</span>sqrt(t)</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> s<span class="op">*</span>norm.cdf(d1) <span class="op">-</span> K<span class="op">*</span>exp(<span class="op">-</span>r<span class="op">*</span>t)<span class="op">*</span>norm.cdf(d2)</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># function calculating implied vol by the bisection method</span></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> bs_impvol_call(<span class="va">self</span>, s0, K, T, C, r<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>        K <span class="op">=</span> np.array([K])</span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(K)</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>        sigmaL, sigmaH <span class="op">=</span> <span class="fl">1e-10</span><span class="op">*</span>np.ones(n), <span class="dv">10</span><span class="op">*</span>np.ones(n)</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>        CL, CH <span class="op">=</span> <span class="va">self</span>.bs_call(s0, K, T, sigmaL, r), <span class="va">self</span>.bs_call(s0, K, T, sigmaH, r)</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> np.mean(sigmaH <span class="op">-</span> sigmaL) <span class="op">&gt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>            sigma <span class="op">=</span> (sigmaL <span class="op">+</span> sigmaH)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>            CM <span class="op">=</span> <span class="va">self</span>.bs_call(s0, K, T, sigma, r)</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>            CL <span class="op">=</span> CL <span class="op">+</span> (CM <span class="op">&lt;</span> C)<span class="op">*</span>(CM <span class="op">-</span> CL)</span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>            sigmaL <span class="op">=</span> sigmaL <span class="op">+</span> (CM <span class="op">&lt;</span> C)<span class="op">*</span>(sigma <span class="op">-</span> sigmaL)</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>            CH <span class="op">=</span> CH <span class="op">+</span> (CM <span class="op">&gt;=</span> C)<span class="op">*</span>(CM <span class="op">-</span> CH)</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>            sigmaH <span class="op">=</span> sigmaH <span class="op">+</span> (CM <span class="op">&gt;=</span> C)<span class="op">*</span>(sigma <span class="op">-</span> sigmaH)    </span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sigma[<span class="dv">0</span>]</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate implied vols</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> imp_vols(<span class="va">self</span>):</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># regress call - put over strike K </span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># apply put-call parity </span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> {<span class="st">'CP'</span>: <span class="va">self</span>.mids_call <span class="op">-</span> <span class="va">self</span>.mids_put, <span class="st">'Strike'</span>: <span class="va">self</span>.ks}</span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> sm.ols(formula<span class="op">=</span><span class="st">'CP ~ Strike'</span>, data<span class="op">=</span>df).fit()</span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>        s_adj, pv <span class="op">=</span> result.params[<span class="dv">0</span>], <span class="op">-</span>result.params[<span class="dv">1</span>]</span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>        ks_pv <span class="op">=</span> <span class="va">self</span>.ks<span class="op">*</span>pv</span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>        days_to_expiry <span class="op">=</span> (dt.strptime(<span class="va">self</span>.expiry, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> <span class="va">self</span>.today).days</span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>        imp_vols <span class="op">=</span> <span class="va">self</span>.bs_impvol_call(s_adj, ks_pv, days_to_expiry<span class="op">/</span><span class="dv">365</span>, <span class="va">self</span>.mids_call, r<span class="op">=</span><span class="dv">0</span>)        </span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'imp_vols'</span>: imp_vols, <span class="st">'pv'</span>: pv, <span class="st">'s_adj'</span>: s_adj}</span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot implied vol</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_imp_vols2(<span class="va">self</span>):</span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="va">self</span>.ivs[<span class="va">self</span>.ivs<span class="op">&gt;</span><span class="fl">0.001</span>]</span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.ks[<span class="va">self</span>.ivs<span class="op">&gt;</span><span class="fl">0.001</span>]</span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>        plt.plot(log(x<span class="op">/</span><span class="va">self</span>.s_adj), y, <span class="st">'b.--'</span>)</span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>        plt.plot(log(x<span class="op">/</span><span class="va">self</span>.s_adj), y, <span class="st">'r.'</span>)</span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'logmoneyness'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'implied volatilities'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Implied volatilities vs Logmoneyness'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>):</span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-58" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>expiry <span class="op">=</span> <span class="st">'2022-08-26'</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> <span class="st">'2022-07-25'</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># today = dt.now()</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>spx_opt <span class="op">=</span> OptionAnalytics([spx_calls, spx_puts], expiry, today)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">#spx_opt = OptionAnalytics([spx_calls, spx_puts], spx_expiries[idx])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_25000\903028481.py:94: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  s_adj, pv = result.params[0], -result.params[1]</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>spx_opt.plot_arb()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>spx_opt.plot_parity()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>spx_opt.s_adj</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>3956.9116921934447</code></pre>
</div>
</div>
<div id="cell-62" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>spx_opt.imp_vols()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_25000\903028481.py:94: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  s_adj, pv = result.params[0], -result.params[1]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>{'imp_vols': array([0.30600045, 0.30595555, 0.2977905 , 0.29545201, 0.28072122,
        0.28232929, 0.2760224 , 0.27571335, 0.26859412, 0.26908309,
        0.27284159, 0.2708769 , 0.26853801, 0.26566743, 0.26527454,
        0.26282943, 0.26242285, 0.2594965 , 0.25959885, 0.25941643,
        0.25750019, 0.25653246, 0.25254566, 0.25387708, 0.25385611,
        0.2507587 , 0.25183417, 0.24960497, 0.24816526, 0.24549749,
        0.2473746 , 0.24511455, 0.24306506, 0.24344569, 0.24239335,
        0.2381772 , 0.23923107, 0.23911993, 0.23822523, 0.23924822,
        0.23345209, 0.23237829, 0.2344444 , 0.23344536, 0.22909791,
        0.22899399, 0.23093383, 0.23010241, 0.22853441, 0.22734051,
        0.22629503, 0.22473931, 0.22267772, 0.22467133, 0.22094489,
        0.22158022, 0.22029972, 0.21894173, 0.22040126, 0.21866736,
        0.21803138, 0.21752707, 0.21522827, 0.21498524, 0.21433691,
        0.21338911, 0.21299896, 0.20983357, 0.21131474, 0.20839273,
        0.20862321, 0.20877018, 0.20719259, 0.20584517, 0.20362794,
        0.20224901, 0.20071144, 0.20063567, 0.19902292, 0.19711411,
        0.19699863, 0.19436676, 0.1925327 , 0.18606077, 0.18129871,
        0.1965902 , 0.22174679]),
 'pv': 0.9978522732469026,
 's_adj': 3956.9116921934447}</code></pre>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>spx_opt.plot_imp_vols2(), spx_opt.plot_imp_vols1()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-45-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="a-shorter-time-to-expiry-option-on-spx" class="level2">
<h2 class="anchored" data-anchor-id="a-shorter-time-to-expiry-option-on-spx">A shorter time to expiry option on SPX</h2>
<section id="tips-you-may-skip-this-part-if-you-encounter-an-error." class="level3">
<h3 class="anchored" data-anchor-id="tips-you-may-skip-this-part-if-you-encounter-an-error.">Tips: You may skip this part if you encounter an error.</h3>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose an expiry </span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> dt.strftime(dt.now(), <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> (dt.strptime(spx_expiries[idx], <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> dt.now()).days</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'option expiry = </span><span class="sc">{</span>spx_expiries[idx]<span class="sc">}</span><span class="ss">, today = </span><span class="sc">{</span>today<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span>day_count<span class="sc">}</span><span class="ss"> days to expiry'</span>)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>option_chain <span class="op">=</span> spx.option_chain(spx_expiries[idx])</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>spx_calls1 <span class="op">=</span> option_chain.calls</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>spx_puts1 <span class="op">=</span> option_chain.puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clean data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>spx_calls1 <span class="op">=</span> spx_calls1.dropna()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>spx_calls1 <span class="op">=</span> spx_calls1[(spx_calls1[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (spx_calls1[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>spx_puts1 <span class="op">=</span> spx_puts1.dropna()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>spx_puts1 <span class="op">=</span> spx_puts1[(spx_puts1[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (spx_puts1[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> dt.now()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>spx_opt1 <span class="op">=</span> OptionAnalytics([spx_calls1, spx_puts1], spx_expiries[idx], today)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>spx_opt1.plot_arb()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>spx_opt1.plot_parity()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>spx_opt.imp_vols()[<span class="st">'pv'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>spx_opt1.s_adj, spx_opt1.imp_vols()[<span class="st">'pv'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>spx_opt1.plot_imp_vols2(), spx_opt1.plot_imp_vols1()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="you-may-start-from-here.-1" class="level3">
<h3 class="anchored" data-anchor-id="you-may-start-from-here.-1">You may start from here.</h3>
</section>
</section>
<section id="gpr-fit-for-spx-implied-volatility-curve" class="level2">
<h2 class="anchored" data-anchor-id="gpr-fit-for-spx-implied-volatility-curve">GPR fit for SPX implied volatility curve</h2>
<div id="cell-76" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The posterior mean function from GPR</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># inputs: </span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># m: prior mean function </span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># k: prior kernel</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># y: observations</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># x: indices</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># output: the posterior mean function</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pos_mean(m, k, y, x, sigma<span class="op">=</span><span class="fl">0.001</span>):</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the covariance matrices</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    tmp, _ <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    Sigma_YY <span class="op">=</span> k(tmp, _)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    Sigma_YY <span class="op">=</span> Sigma_YY <span class="op">+</span> sigma<span class="op">**</span><span class="dv">2</span><span class="op">*</span>np.identity(n)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># determine Sigma_YY_inv(Y - EY) by solving the linear system Sigma_YY x = Y - EY</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    Sigma_YY_inv_Y_EY <span class="op">=</span> np.linalg.solve(Sigma_YY, y <span class="op">-</span> m(x))</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return the posterior mean function</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">lambda</span> xx: m(xx) <span class="op">+</span> <span class="bu">sum</span>(k(xx, x)<span class="op">*</span>Sigma_YY_inv_Y_EY)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a><span class="co"># The posterior kernel from GPR</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co"># inputs: </span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="co"># k: prior kernel</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="co"># x: indices</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="co"># output: the posterior kernel</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pos_kernel(k, x, sigma<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the covariance matrices</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>    tmp, _ <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>    Sigma_YY <span class="op">=</span> k(tmp, _)</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    Sigma_YY <span class="op">=</span> Sigma_YY <span class="op">+</span> sigma<span class="op">**</span><span class="dv">2</span><span class="op">*</span>np.identity(n)</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return the posterior kernel</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _(xx, xp):</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># determine Sigma_YY_inv Sigma_Yxp by solving the linear system Sigma_YY x = Sigma_Yxp</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>        Sigma_YY_inv_Yxp <span class="op">=</span> np.linalg.solve(Sigma_YY, k(xp, x))</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>        Sigma_xY <span class="op">=</span> k(xx, x)</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> k(xx, xp) <span class="op">-</span> <span class="bu">sum</span>(Sigma_xY<span class="op">*</span>Sigma_YY_inv_Yxp)</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _ </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>imp_vols <span class="op">=</span> spx_opt.ivs</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>logmnyns <span class="op">=</span> np.log(spx_opt.ks<span class="op">/</span>spx_opt.s_adj)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set hyperparameters by guessing</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>A, l, sigma <span class="op">=</span> <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.01</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># prior mean function</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># set prior mean as sample mean of implied vols</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>iv_mean <span class="op">=</span> imp_vols.mean()</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>mpr <span class="op">=</span> <span class="kw">lambda</span> x: iv_mean</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co"># prior kernel</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="kw">lambda</span> x, y: A<span class="op">*</span>np.exp(<span class="op">-</span>np.<span class="bu">abs</span>(x<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span><span class="op">/</span>l<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="co"># indices and observations</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>x_is <span class="op">=</span> logmnyns</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(x_is)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>y_is <span class="op">=</span> imp_vols</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior mean function for implied vol</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> pos_mean(mpr, k, y_is, x_is, sigma<span class="op">=</span>sigma)</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> np.vectorize(mpo_iv)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>mpo_iv(x_is)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted values</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>iv_hat <span class="op">=</span> mpo_iv(x_is)</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(y_is, iv_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.307461</td>
<td>0.306000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.299448</td>
<td>0.305956</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.298590</td>
<td>0.297790</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.294401</td>
<td>0.295452</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.288030</td>
<td>0.280721</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.192479</td>
<td>0.192533</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.185995</td>
<td>0.186061</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.181538</td>
<td>0.181299</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.196908</td>
<td>0.196590</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.221521</td>
<td>0.221747</td>
</tr>
</tbody>
</table>

<p>87 rows × 1 columns</p>
</div>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot </span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, y_is, <span class="st">'bo'</span>, label<span class="op">=</span><span class="st">'Market data'</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'implied vol'</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(x_is.<span class="bu">min</span>(), x_is.<span class="bu">max</span>(), <span class="dv">200</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>plt.plot(x, mpo_iv(x), <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'GPR fit'</span>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-56-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-79" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># analysis on absolute errors </span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>abs_errs <span class="op">=</span> np.<span class="bu">abs</span>(iv_hat <span class="op">-</span> y_is)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, abs_errs, <span class="st">'bo'</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>, fontsize<span class="op">=</span><span class="dv">12</span>) </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'errors'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(abs_errs).describe().transpose()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>87.0</td>
<td>0.001156</td>
<td>0.001303</td>
<td>0.000011</td>
<td>0.000347</td>
<td>0.000829</td>
<td>0.001325</td>
<td>0.007309</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-57-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="fine-tune-hyperparameters-by-mle" class="level3">
<h3 class="anchored" data-anchor-id="fine-tune-hyperparameters-by-mle">Fine tune hyperparameters by MLE</h3>
<div id="cell-81" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the hyperparameters by MLE</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># objective function</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> obj(x, y):</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _(params):</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        A, l, sigma <span class="op">=</span> params</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="kw">lambda</span> u, v: A<span class="op">*</span>np.exp(<span class="op">-</span>np.<span class="bu">abs</span>(u<span class="op">-</span>v)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span><span class="op">/</span>l<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate the covariance matrices</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        tmp, _ <span class="op">=</span> np.meshgrid(x, x)</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        Sigma_YY <span class="op">=</span> k(tmp, _)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        Sigma_YY <span class="op">=</span> Sigma_YY <span class="op">+</span> sigma<span class="op">**</span><span class="dv">2</span><span class="op">*</span>np.identity(n)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        Sigma_YY_inv_y <span class="op">=</span> np.linalg.solve(Sigma_YY, y)        </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.log(np.linalg.det(Sigma_YY)) <span class="op">+</span> <span class="bu">sum</span>(y<span class="op">*</span>Sigma_YY_inv_y) <span class="co">#this is in fact negative log likelihood</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-82" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># minimize objective function</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(obj(x_is, y_is)([<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>]))</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>pars <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> minimize(obj(x_is, y_is), pars, method<span class="op">=</span><span class="st">'nelder-mead'</span>, </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>               options<span class="op">=</span>{<span class="st">'xatol'</span>: <span class="fl">1e-8</span>, <span class="st">'disp'</span>: <span class="va">True</span>}) </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>hyparams <span class="op">=</span> res.x</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>hyparams</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-381.2423169273305</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_25000\1457444304.py:14: RuntimeWarning: divide by zero encountered in log
  return np.log(np.linalg.det(Sigma_YY)) + sum(y*Sigma_YY_inv_y) #this is in fact negative log likelihood
c:\Python\Lib\site-packages\scipy\optimize\_optimize.py:917: RuntimeWarning: invalid value encountered in subtract
  np.max(np.abs(fsim[0] - fsim[1:])) &lt;= fatol):</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: total: 16.2 s
Wall time: 3.71 s</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;timed exec&gt;:4: RuntimeWarning: Maximum number of function evaluations has been exceeded.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>array([ 0.13481481,  0.16574074, -0.00740741])</code></pre>
</div>
</div>
<div id="cell-84" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hyperparameters estimated from MLE</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>A, l, sigma <span class="op">=</span> hyparams</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># prior mean function</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set prior mean as sample mean of implied vols</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>iv_mean <span class="op">=</span> imp_vols.mean()</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>mpr <span class="op">=</span> <span class="kw">lambda</span> x: iv_mean</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co"># prior kernel</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="kw">lambda</span> x, y: A<span class="op">*</span>np.exp(<span class="op">-</span>np.<span class="bu">abs</span>(x<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span><span class="op">/</span>l<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co"># indices and observations</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>x_is <span class="op">=</span> logmnyns</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(x_is)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>y_is <span class="op">=</span> imp_vols</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior mean function for implied vol</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> pos_mean(mpr, k, y_is, x_is, sigma<span class="op">=</span>sigma)</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> np.vectorize(mpo_iv)</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="co">#mpo_iv(x_is)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-85" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot </span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, y_is, <span class="st">'bo'</span>, label<span class="op">=</span><span class="st">'Market data'</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'implied vol'</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(x_is.<span class="bu">min</span>(), x_is.<span class="bu">max</span>(), <span class="dv">200</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>plt.plot(x, mpo_iv(x), <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'GPR fit'</span>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-86" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># analysis on absolute errors </span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>abs_errs <span class="op">=</span> np.<span class="bu">abs</span>(iv_hat <span class="op">-</span> y_is)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, abs_errs, <span class="st">'bo'</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>, fontsize<span class="op">=</span><span class="dv">12</span>) </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'errors'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(abs_errs).describe().transpose()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>87.0</td>
<td>0.001156</td>
<td>0.001303</td>
<td>0.000011</td>
<td>0.000347</td>
<td>0.000829</td>
<td>0.001325</td>
<td>0.007309</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-63-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="what-is-vix" class="level2">
<h2 class="anchored" data-anchor-id="what-is-vix">What is VIX?</h2>
<p>Quote from <a href="https://www.investopedia.com/terms/v/vix.asp">this page</a> in Investopedia:</p>
<blockquote class="blockquote">
<p>Created by the Chicago Board Options Exchange (CBOE), the Volatility Index, or VIX, is a real-time market index that represents the market’s expectation of 30-day forward-looking volatility. Derived from the price inputs of the S&amp;P 500 index options, it provides a measure of market risk and investors’ sentiments. It is also known by other names like “Fear Gauge” or “Fear Index.” Investors, research analysts and portfolio managers look to VIX values as a way to measure market risk, fear and stress before they take investment decisions.</p>
</blockquote>
<blockquote class="blockquote">
<p>Introduced in 1993, the Volatility Index (VIX) was initially a weighted measure of the implied volatility (IV) of eight S&amp;P 100 at-the-money put and call options. Ten years later, in 2004, it expanded to use options based on a broader index, the S&amp;P 500. This expansion allows for a more accurate view of investors’ expectations on future market volatility. VIX values higher than 30 are usually associated with a significant amount of volatility as a result of investor fear or uncertainty. Values below 15 ordinarily correspond to less stressful, or even complacent, times in the markets.</p>
</blockquote>
<ul>
<li><p>Originally, the VIX computation was designed to mimic the implied volatility of an at-the-money 1 month option on the OEX index. It did this by averaging volatilities from 8 options (puts and calls from the closest to ATM strikes in the nearest and next to nearest months).</p></li>
<li><p>The CBOE changed the VIX computation: “CBOE is changing VIX to provide a more precise and robust measure of expected market volatility and to create a viable underlying index for tradable volatility products.”</p></li>
<li><p>CBOE listed futures on the VIX in 2004.</p></li>
</ul>
</section>
<section id="volatility-indices-published-by-cboe" class="level2">
<h2 class="anchored" data-anchor-id="volatility-indices-published-by-cboe">Volatility indices published by CBOE</h2>
<p>In addition to VIX, other volatility indices published by <a href="http://www.cboe.com/products/vix-index-volatility/volatility-on-stock-indexes/cboe-s-p-500-9-day-vol-index-vix9d">CBOE</a> include</p>
<ul>
<li>VIX9D</li>
<li>VIX3M</li>
<li>VIX6M</li>
<li>VOX</li>
<li>VXD: Dow Jones index volatility</li>
<li>RVX</li>
<li>VXN</li>
<li>VVIX: VIX of VIX.</li>
</ul>
<section id="note-1" class="level3">
<h3 class="anchored" data-anchor-id="note-1">Note</h3>
<p>More volatility indices published by CBOE can be found in <a href="http://www.cboe.com/Volatility">this link</a>.</p>
</section>
</section>
<section id="formula-of-finanical-engineering" class="level2">
<h2 class="anchored" data-anchor-id="formula-of-finanical-engineering">“Formula of finanical engineering”</h2>
<p>Notice that all payoffs we saw before can be expressed as a combination of payoffs from calls and puts, even the underlying itself since it can be regarded as a call struck at zero. A natural question to ask is, to what extent, can a given payoff function be represented as a combination of calls and puts?</p>
<p>The answer is surprisingly “all the payoffs”! The following formula shows how.</p>
<p>Let <span class="math inline">\(\varphi\)</span> be a payoff function, we have</p>
<p><span class="math display">\[
\varphi(s) = \varphi(f) + \varphi'(f)(s - f) + \int_f^\infty (s - k)^+ \varphi''(k) dk + \int_0^f (k - s)^+ \varphi''(k)dk.
\]</span></p>
<p>Let <span class="math inline">\(\delta\)</span> denote the Dirac delta function and <span class="math inline">\(\theta\)</span> the Heaviside function. Note that heuristically <span class="math inline">\(\theta' = \delta\)</span>, i.e., the Dirac delta can be regarded as the derivative of the Heaviside function.</p>
<p>The payoff <span class="math inline">\(\varphi(s)\)</span> at time <span class="math inline">\(T\)</span> can be written as</p>
<span class="math display">\[\begin{aligned}
\varphi(s) &amp;= \int_0^\infty \varphi(k) \delta(s - k)\,dk \\
&amp;= \int_0^f \varphi(k) \delta(s - k)\,dk + \int_f^\infty \varphi(k) \delta(s - k)\,dk \\
&amp;= \varphi(f) - \int_0^f \varphi'(k) \theta(k - s)\,dk + \int_f^\infty \varphi'(k) \theta(s - k)\,dk \\
&amp;= \varphi(f) + \varphi'(f) (s - f) + \int_0^f \varphi''(k) (k - s)^+\,dk + \int_f^\infty \varphi''(k) (s - k)^+\,dk.
\end{aligned}\]</span>
<p>Thus,</p>
<p><span class="math display">\[
\varphi(S_T) = \varphi(f) + \varphi'(f) (S_T - f) + \int_0^f \varphi''(k) (k - S_T)^+ dk + \int_f^\infty \varphi''(k) (S_T - k)^+ dk.
\]</span></p>
<p>With <span class="math inline">\(f = \Eof{S_T}\)</span> and taking expectation on both sides, we end up</p>
<span class="math display">\[\begin{aligned}
\E[\varphi(S_T)] &amp;= \varphi(f) + \int_0^f \varphi''(k) P(k)\, dk + \int_f^\infty \varphi''(k) C(k)\, dk.
\end{aligned}\]</span>
<ul>
<li>The price of any European style contingent claim can be expressed in terms of strips of out-of-money European options.</li>
</ul>
</section>
<section id="example---log-contract" class="level2">
<h2 class="anchored" data-anchor-id="example---log-contract">Example - log contract</h2>
<p>Consider the log contract <span class="math inline">\(\varphi(s) = \log s\)</span>. Since <span class="math inline">\(\varphi'(s) = \frac1s\)</span> and <span class="math inline">\(\varphi''(s) = -\frac1{s^2}\)</span>, we obtain</p>
<p><span class="math display">\[
\log s = \log f + \frac{s - f}{f} - \int_0^f \frac{(k - s)^+}{k^2} dk - \int_f^\infty \frac{(s - k)^+}{k^2} dk.
\]</span></p>
<p>Thus,</p>
<p><span class="math display">\[
\Eof{\log S_T} = \log f - \int_0^f \, \frac{P(k)}{k^2} \,dk - \int_f^\infty\, \frac{C(k)}{k^2} \,dk.
\]</span></p>
<p>On the other hand, assume <span class="math inline">\(S_t\)</span> satisfies the SDE under risk neutral probability with zero interest and dividend rates</p>
<p><span class="math display">\[
\frac{dS_t}{S_t} = \sigma_t dW_t,
\]</span></p>
<p>by applying Ito’s formula to <span class="math inline">\(\log S_t\)</span>, we obtain</p>
<p><span class="math display">\[
\log S_T = \log S_0 + \int_0^T \sigma_t \, dW_t - \frac{1}{2} \int_0^T \sigma_t^2 \, dt.
\]</span></p>
<p>It follows by taking expectation on both sides that</p>
<p><span class="math display">\[
\Eof{\log S_T} = \log S_0 - \frac12 \Eof{\int_0^T \sigma_t^2 dt}
\]</span></p>
<p>Compare the two identities we obtain</p>
<p><span class="math display">\[
\frac1T \Eof{\int_0^T \sigma_t^2 dt} = \frac2T \int_0^f \, \frac{P(k)}{k^2} \,dk + \frac2T \int_f^\infty\, \frac{C(k)}{k^2} \,dk.
\]</span></p>
<section id="note-2" class="level3">
<h3 class="anchored" data-anchor-id="note-2">Note</h3>
<ul>
<li>Modulo the diffusion process assumption on the underlying, the last relationship is model-free.<br>
</li>
<li>VIX is calculated based on this formula with <span class="math inline">\(T\)</span> equal to a month.</li>
</ul>
</section>
</section>
<section id="how-is-vix-calculated" class="level2">
<h2 class="anchored" data-anchor-id="how-is-vix-calculated">How is VIX calculated?</h2>
<p>VIX definition in the CBOE white paper:</p>
<p><span class="math display">\[VIX^2=\frac{2}{T}\,\sum_i\,\frac{\Delta K_i}{K_i^2}\,
Q_i(K_i)\,-\,\frac{1}{T}\,\left[\frac{F}{K_0}-1\right]^2
\]</span></p>
<p>where <span class="math inline">\(Q_i\)</span> is the price of the out-of-the-money option with strike <span class="math inline">\(K_i\)</span> and <span class="math inline">\(K_0\)</span> is the highest strike below the forward price <span class="math inline">\(F\)</span>. <span class="math inline">\(T\)</span> is one month.</p>
<section id="download-vix-data-from-yfinance" class="level3">
<h3 class="anchored" data-anchor-id="download-vix-data-from-yfinance">Download VIX data from <code>yfinance</code></h3>
</section>
<section id="you-may-skip-this-part-if-you-encounter-an-error." class="level3">
<h3 class="anchored" data-anchor-id="you-may-skip-this-part-if-you-encounter-an-error.">You may skip this part if you encounter an error.</h3>
<div id="cell-96" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="st">'2007-01-01'</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>end <span class="op">=</span> <span class="st">'2022-07-29'</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>vix <span class="op">=</span> yf.download(<span class="st">'^VIX'</span>, start<span class="op">=</span>start, end<span class="op">=</span>end)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>vix <span class="op">=</span> vix.drop(<span class="st">'Volume'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>vix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>vix[<span class="st">'Close'</span>].plot(label<span class="op">=</span><span class="st">'VIX'</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.plot(spx_vol*100, 'r-.', label='Historical Volatility')</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-98" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot log(vix)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>log(vix)[<span class="st">'Close'</span>].plot(label<span class="op">=</span><span class="st">'log ViX'</span>)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="volatility-derivatives" class="level2">
<h2 class="anchored" data-anchor-id="volatility-derivatives">Volatility derivatives</h2>
<ul>
<li>variance swap</li>
<li>volatility swap</li>
<li>VIX futures</li>
<li>VIX options</li>
</ul>
</section>
<section id="variance-swap" class="level2">
<h2 class="anchored" data-anchor-id="variance-swap">Variance swap</h2>
<p>Quote from the <a href="https://en.wikipedia.org/wiki/Variance_swap">Wikipage</a>:</p>
<blockquote class="blockquote">
<p>A variance swap is an over-the-counter financial derivative that allows one to speculate on or hedge risks associated with the magnitude of movement, i.e.&nbsp;volatility, of some underlying product, like an <font color="blue"> exchange rate </font>, <font color="blue">interest rate</font>, or stock index.</p>
</blockquote>
<blockquote class="blockquote">
<p>One leg of the swap will pay an amount based upon the realized variance of the price changes of the underlying product. Conventionally, these price changes will be daily log returns, based upon the most commonly used closing price. The other leg of the swap will pay a fixed amount, which is the strike, quoted at the deal’s inception. Thus the net payoff to the counterparties will be the difference between these two and will be settled in cash at the expiration of the deal, though some cash payments will likely be made along the way by one or the other counterparty to maintain agreed upon margin.</p>
</blockquote>
<p>In summary, a variance swap is a forward contract on realized (annualized) variance whose payoff function ideally is given by</p>
<p><span class="math display">\[
N \times \left(\frac1T \int_0^T \sigma_t^2 dt - K \right)
\]</span></p>
<p>where <span class="math inline">\(K\)</span> is the strike and <span class="math inline">\(N\)</span> denotes the notional.</p>
</section>
<section id="volatility-swap" class="level2">
<h2 class="anchored" data-anchor-id="volatility-swap">Volatility swap</h2>
<p>Quote from the <a href="https://en.wikipedia.org/wiki/Volatility_swap">Wikipage</a>:</p>
<blockquote class="blockquote">
<p>In finance, a volatility swap is a forward contract on the future realised volatility of a given underlying asset. Volatility swaps allow investors to trade the volatility of an asset directly, much as they would trade a price index.</p>
</blockquote>
<blockquote class="blockquote">
<p>The underlying is usually a foreign exchange (FX) rate (very liquid market) but could be as well a single name equity or index. However, the variance swap is preferred in the equity market because it can be replicated with a linear combination of options and a dynamic position in futures.</p>
</blockquote>
<blockquote class="blockquote">
<p>Unlike a stock option, whose volatility exposure is contaminated by its stock price dependence, these swaps provide pure exposure to volatility alone. This is truly the case only for forward starting volatility swaps. However, once the swap has its asset fixings its mark-to-market value also depends on the current asset price. One can use these instruments to speculate on future volatility levels, to trade the spread between realized and implied volatility, or to hedge the volatility exposure of other positions or businesses.</p>
</blockquote>
<p>In summary, a volatility swap is a forward contract on realized (annualized) volatility whose payoff function ideally is given by</p>
<p><span class="math display">\[
N \times \left(\sqrt{\frac1T \int_0^T \sigma_t^2 dt} - K \right)
\]</span></p>
<p>where <span class="math inline">\(K\)</span> is the strike and <span class="math inline">\(N\)</span> denotes the notional.</p>
</section>
<section id="calculating-volatility-swap-fair-strike-from-mgf" class="level2">
<h2 class="anchored" data-anchor-id="calculating-volatility-swap-fair-strike-from-mgf">Calculating volatility swap fair strike from MGF</h2>
<p>By applying the following formula</p>
<p><span class="math display">\[
\sqrt x = \frac1{2\sqrt\pi}\int_0^\infty s^{-\frac32}\left(1 - e^{-xs}\right) ds,
\]</span></p>
<p>we obtain</p>
<p><span class="math display">\[
\Eof{\sqrt{\frac1T \int_0^T \sigma_t^2 dt}} = \frac1{2\sqrt\pi}\int_0^\infty s^{-\frac32}\left(1 - \Eof{e^{-xs}}\right) ds
\]</span></p>
<p>where apparently,</p>
<p><span class="math display">\[
x = \frac1T \int_0^T \sigma_t^2 dt
\]</span></p>
<p>and <span class="math inline">\(\Eof{e^{-xs}}\)</span> the moment generating function for realized variance.</p>
</section>
<section id="vix-futures" class="level2">
<h2 class="anchored" data-anchor-id="vix-futures">VIX futures</h2>
<p>According to the <a href="https://cfe.cboe.com/cfe-products/vx-cboe-volatility-index-vix-futures">VIX page</a> on CBOE,</p>
<blockquote class="blockquote">
<p>Introduced in 2004 on Cboe Futures Exchange (CFE), VIX futures provide market participants with the ability to trade a liquid volatility product based on the VIX Index methodology. VIX futures reflect the market’s estimate of the value of the VIX Index on various expiration dates in the future. VIX futures provide market participants with a variety of opportunities to implement their view using volatility trading strategies, including risk management, alpha generation and portfolio diversification.</p>
</blockquote>
</section>
<section id="vix-option" class="level2">
<h2 class="anchored" data-anchor-id="vix-option">VIX option</h2>
<p>Quote from <a href="https://www.investopedia.com/terms/v/vixoption.asp">this page</a> in Invstopeida</p>
<blockquote class="blockquote">
<p>A VIX option is a non-equity index option that uses the CBOE Volatility Index as its underlying asset. Call and put VIX options are both available. The call options hedge portfolios against a sudden market decline, and put options hedge against a rapid reversal of short positions on the S&amp;P 500 index. These options thus allow traders and investors to speculate on future moves in volatility.</p>
</blockquote>
</section>
<section id="a-look-at-the-vix-option-chain-from-yahoo-finance" class="level2">
<h2 class="anchored" data-anchor-id="a-look-at-the-vix-option-chain-from-yahoo-finance">A look at the VIX option chain from Yahoo Finance</h2>
<p>Visit this <a href="https://finance.yahoo.com/quote/%5EVIX/options/">Yahoo Finance link for VIX option chain</a>.</p>
<section id="you-may-skip-the-next-5-cells-if-you-encounter-an-error." class="level3">
<h3 class="anchored" data-anchor-id="you-may-skip-the-next-5-cells-if-you-encounter-an-error.">You may skip the next 5 cells if you encounter an error.</h3>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>vix <span class="op">=</span> yf.Ticker(<span class="st">'^VIX'</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>vix_expiries <span class="op">=</span> vix.options</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vix_expiries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># choose an expiry </span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> dt.strftime(dt.now(), <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> (dt.strptime(vix_expiries[idx], <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> dt.now()).days</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'option expiry = </span><span class="sc">{</span>vix_expiries[idx]<span class="sc">}</span><span class="ss">, today = </span><span class="sc">{</span>today<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span>day_count<span class="sc">}</span><span class="ss"> days to expiry'</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>option_chain <span class="op">=</span> vix.option_chain(vix_expiries[idx])</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>vix_calls, vix_puts <span class="op">=</span> option_chain.calls, option_chain.puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-109" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># clean data</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>vix_calls <span class="op">=</span> vix_calls.drop([<span class="st">'currency'</span>, <span class="st">'contractSize'</span>], axis <span class="op">=</span> <span class="dv">1</span>).dropna()</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>vix_calls <span class="op">=</span> vix_calls[(vix_calls[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (vix_calls[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>vix_calls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-110" class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>vix_puts <span class="op">=</span> vix_puts.drop([<span class="st">'currency'</span>, <span class="st">'contractSize'</span>], axis <span class="op">=</span> <span class="dv">1</span>).dropna()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>vix_puts <span class="op">=</span> vix_puts[(vix_puts[<span class="st">'bid'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (vix_puts[<span class="st">'ask'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>vix_puts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-111" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save data</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co">#vix_calls.to_csv('vixcall_07252022.csv', index=False)</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co">#vix_puts.to_csv('vixput_07252022.csv', index=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="you-may-start-from-here.-2" class="level3">
<h3 class="anchored" data-anchor-id="you-may-start-from-here.-2">You may start from here.</h3>
<div id="cell-113" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in saved data</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>vix_calls <span class="op">=</span> pd.read_csv(<span class="st">'vixcall_07252022.csv'</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>vix_puts <span class="op">=</span> pd.read_csv(<span class="st">'vixput_07252022.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-114" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>expiry, today <span class="op">=</span> <span class="st">'2022-08-24'</span>, <span class="st">'2022-07-25'</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>vix_opt <span class="op">=</span> OptionAnalytics([vix_calls, vix_puts], expiry, today)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co">#vix_opt = OptionAnalytics([vix_calls, vix_puts], vix_expiries[idx], dt.now())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_25000\903028481.py:94: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  s_adj, pv = result.params[0], -result.params[1]</code></pre>
</div>
</div>
<div id="cell-115" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>vix_opt.plot_arb()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-74-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-116" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>vix_opt.plot_parity()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-75-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-117" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>vix_opt.plot_imp_vols2(), vix_opt.plot_imp_vols1()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-76-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-76-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="gpr-fit-for-vix-option-implied-volatility-curve" class="level2">
<h2 class="anchored" data-anchor-id="gpr-fit-for-vix-option-implied-volatility-curve">GPR fit for VIX option implied volatility curve</h2>
<div id="cell-119" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>imp_vols <span class="op">=</span> vix_opt.ivs[<span class="dv">1</span>:]</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co">#imp_vols = vix_opt.ivs</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>logmnyns <span class="op">=</span> np.log(vix_opt.ks[<span class="dv">1</span>:]<span class="op">/</span>vix_opt.s_adj)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set hyperparameters by guessing</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>sigma, A, l <span class="op">=</span> <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co"># prior mean function</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="co"># set prior mean as sample mean of implied vols</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>iv_mean <span class="op">=</span> imp_vols.mean()</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>mpr <span class="op">=</span> <span class="kw">lambda</span> x: iv_mean</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="co"># prior kernel</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="kw">lambda</span> x, y: A<span class="op">*</span>np.exp(<span class="op">-</span>np.<span class="bu">abs</span>(x<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="dv">2</span><span class="op">/</span>l<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="co"># indices and observations</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>x_is <span class="op">=</span> logmnyns</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(x_is)</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>y_is <span class="op">=</span> imp_vols</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior mean function for implied vol</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> pos_mean(mpr, k, y_is, x_is, sigma<span class="op">=</span>sigma)</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>mpo_iv <span class="op">=</span> np.vectorize(mpo_iv)</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>mpo_iv(x_is)</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted values</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>iv_hat <span class="op">=</span> mpo_iv(x_is)</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(y_is, iv_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.794121</td>
<td>0.823381</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.612930</td>
<td>0.562470</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.561423</td>
<td>0.581719</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.612908</td>
<td>0.626235</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.685567</td>
<td>0.651083</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.736006</td>
<td>0.768180</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.767337</td>
<td>0.752712</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.796917</td>
<td>0.795185</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.833553</td>
<td>0.833420</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.874426</td>
<td>0.875310</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0.912757</td>
<td>0.919806</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0.945017</td>
<td>0.938292</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1.010601</td>
<td>1.014723</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1.074513</td>
<td>1.072477</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1.127997</td>
<td>1.134668</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1.184969</td>
<td>1.182831</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1.275277</td>
<td>1.285238</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-120" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot </span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, y_is, <span class="st">'bo'</span>, label<span class="op">=</span><span class="st">'Market data'</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'implied vol'</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(x_is.<span class="bu">min</span>(), x_is.<span class="bu">max</span>(), <span class="dv">200</span>)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>plt.plot(x, mpo_iv(x), <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'GPR fit'</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-121" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># analysis on absolute errors </span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>abs_errs <span class="op">=</span> np.<span class="bu">abs</span>(iv_hat <span class="op">-</span> y_is)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_is, abs_errs, <span class="st">'bo'</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'logmoneyness'</span>, fontsize<span class="op">=</span><span class="dv">12</span>) </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'errors'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(abs_errs).describe().transpose()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>17.0</td>
<td>0.013887</td>
<td>0.01462</td>
<td>0.000133</td>
<td>0.002138</td>
<td>0.007049</td>
<td>0.020297</td>
<td>0.05046</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-79-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="appendix-optional" class="level2">
<h2 class="anchored" data-anchor-id="appendix-optional">Appendix (Optional)</h2>
</section>
<section id="volatility-estimation-using-high-frequency-data" class="level2">
<h2 class="anchored" data-anchor-id="volatility-estimation-using-high-frequency-data">Volatility estimation using high frequency data</h2>
<ul>
<li>Market microstructure noise may contaminate the data in high frequency, resulting in inconsistency of estimators.</li>
</ul>
</section>
<section id="realized-variance" class="level2">
<h2 class="anchored" data-anchor-id="realized-variance">Realized variance</h2>
<p>The following estimator is called the <em>Realized Variance (RV)</em> estimator</p>
<p><span class="math display">\[
\sum_{i=1}^n \, \left(Y_{t_i} - Y_{t_{i-1}} \right)^2
= \sum_{i=1}^n \, \left( \Delta Y_{t_i} \right)^2,
\]</span></p>
<p>where <span class="math inline">\(Y_t = \log S_t\)</span> and <span class="math inline">\(S_t\)</span> is the price series of the asset under consideration.</p>
<section id="technical-notes" class="level3">
<h3 class="anchored" data-anchor-id="technical-notes">Technical notes</h3>
<ul>
<li>Realized variance and realized covariance <br> Given a partition <span class="math inline">\(\Pi = \{0 = t_1 &lt; \cdots &lt; t_n=T\}\)</span> of the interval <span class="math inline">\([0, T]\)</span>, the realized variance <span class="math inline">\([X]_T^\Pi\)</span> of the process <span class="math inline">\(X_t\)</span> sampled at <span class="math inline">\(\Pi\)</span> is defined by <span class="math display">\[
[X]_T^\Pi = \sum_{i=1}^n |X_{t_i} - X_{t_{i-1}}|^2.
\]</span></li>
</ul>
<p>Similiarly, the realized covariance between <span class="math inline">\(X_t\)</span> and <span class="math inline">\(Y_t\)</span> sampled at <span class="math inline">\(\Pi\)</span> is given by</p>
<p><span class="math display">\[
[X, Y]_T^\Pi = \sum_{i=1}^n (X_{t_i} - X_{t_{i-1}})(Y_{t_i} - Y_{t_{i-1}})
\]</span></p>
<ul>
<li><p>Quadratic variation (integrated variance) and covariation <br> The quadratic variation of <span class="math inline">\(X\)</span> is defined by the limit <span class="math display">\[
  \angl{X}_t = \lim_{\|\Pi_n\| \to 0} [X]_T^{\Pi_n}
  \]</span> provided the limit exists. <span class="math inline">\(\Pi_n\)</span> denotes a sequence of partitions of the interval <span class="math inline">\([0, T]\)</span> such that <span class="math inline">\(\|\Pi_n\| \to 0\)</span> as <span class="math inline">\(n \to \infty\)</span>, where <span class="math inline">\(\|\Pi_n\|\)</span> denotes the mesh of the partition <span class="math inline">\(\Pi_n\)</span>.</p>
<p>Likewise, the covariation between and <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is defined by the limit <span class="math display">\[
  \angl{X, Y}_t = \lim_{\|\Pi_n\| \to 0} [X, Y]_T^{\Pi_n}.
  \]</span></p></li>
</ul>
</section>
<section id="assumption" class="level3">
<h3 class="anchored" data-anchor-id="assumption">Assumption</h3>
<p>The log price <span class="math inline">\(X_t\)</span> follows the Ito process</p>
<p><span class="math display">\[
dX_t = \mu_t dt + \sigma_t dW_t,
\]</span></p>
<p>where <span class="math inline">\(W_t\)</span> is a Brownian motion. Under the assumption, <span class="math inline">\(\angl{X}_t = \int_0^t \sigma_\tau^2 d\tau\)</span>.</p>
</section>
</section>
<section id="integrated-variance-or-quadratic-variation" class="level2">
<h2 class="anchored" data-anchor-id="integrated-variance-or-quadratic-variation">Integrated variance or quadratic variation</h2>
<p>Given a set of tick data, how can we measure the, say daily, variance? <br> A possibility is to estimate the <em>integrated variance</em>, also known as the <em>quadratic variation</em> in the theory of semimartingale. We shall use both terms interchangeably hereafter.</p>
<p>Recall that the <em>quadratic variation</em> <span class="math inline">\(\angl{X}_t\)</span> of the continuous stochastic process <span class="math inline">\(X_t\)</span> is defined by</p>
<p><span class="math display">\[
\angl{X}_T:= \lim_{\|\Pi_n\| \to 0} \sum_{{t_i} \in \Pi_n} |\Delta X_{t_i}|^2
\]</span></p>
<p>provided the limit exist (in probability).</p>
<p>Thus, the goal is to estimate the quadratic variation of the efficient log price from the transacted log price, i.e., tick data. However, the subtlety is that efficient price is not directly observable and is contaminated by market microstructure noises.</p>
<section id="note-3" class="level4">
<h4 class="anchored" data-anchor-id="note-3">Note</h4>
<ul>
<li><p>If the process <span class="math inline">\(X\)</span> has jumps, the quadratic variation <span class="math inline">\(\angl{X}\)</span> becomes</p>
<span class="math display">\[\begin{aligned}
  \langle X \rangle_t &amp;= \langle X^c \rangle_t + \sum_{0 &lt; s \leq t} |\Delta X_s|^2,
  \end{aligned}\]</span>
<p>where <span class="math inline">\(X^c\)</span> denotes the continuous part of <span class="math inline">\(X\)</span> and <span class="math inline">\(\Delta X_s := X_s - X_{s^-}\)</span> is the jump size at time <span class="math inline">\(s\)</span>. In this case, the integrated variance usually refers to <span class="math inline">\(\langle X^c \rangle\)</span>, i.e., the quadratic variation of the continuous part.</p></li>
<li><p>We shall always assume <span class="math inline">\(X\)</span> is a continuous process, thus no jumps, in the sequel.</p></li>
</ul>
</section>
<section id="microstructure-noise" class="level3">
<h3 class="anchored" data-anchor-id="microstructure-noise">Microstructure noise</h3>
<p>In the limit of very high sampling frequency, RV picks up mainly the market microstructure noise. To see this, suppose that the observed price <span class="math inline">\(Y_t\)</span> is given by</p>
<p><span class="math display">\[Y_t =X_t +\epsilon_t,\]</span></p>
<p>where <span class="math inline">\(X_t\)</span> is the value of the underlying (log-)price process of interest and <span class="math inline">\(\epsilon_t\)</span> is a random market microstructure-related noise term, assumed independent of <span class="math inline">\(X_t\)</span>. Suppose we sample the price series <span class="math inline">\(n+1\)</span> times (so that there are <span class="math inline">\(n\)</span> price changes) at <span class="math inline">\(\Pi=\{0=t_0 &lt; \cdots &lt; t_n = T\}\)</span> in the time interval <span class="math inline">\([0, T]\)</span>.</p>
<p>Note that, conditioned on <span class="math inline">\(\cF_T^X\)</span>, the conditional expectation of the realized variance of transacted (log) price satisties</p>
<span class="math display">\[\begin{aligned}
\E\left([Y]_T^\Pi \mid \mathcal{F}_T^X\right) &amp;:= \sum_{i=1}^n \E\left((\Delta Y_{t_i})^2 \mid \mathcal{F}_T^X\right) \\
&amp;= \sum_{i=1}^n (\Delta X_{t_i})^2 + 2 \sum_{i=1}^n \Delta X_{t_i} \E\left(\Delta \epsilon_{t_i} \mid \mathcal{F}_T^X\right) + \sum_{i=1}^n \E\left((\Delta \epsilon_{t_i})^2 \mid \mathcal{F}_T^X\right) \\
&amp;= [X]_T + 2 n \, \text{var}[\epsilon] \\
&amp;\approx \langle X \rangle_T + 2 n \, \text{var}[\epsilon].
\end{aligned}\]</span>
<section id="note-4" class="level4">
<h4 class="anchored" data-anchor-id="note-4">Note</h4>
<p>The difference between <span class="math inline">\([X]_T\)</span> and <span class="math inline">\(\angl{X}_T\)</span> is referred to as the <em>discretization error</em>, which is usually controled by the integrated quarticity <span class="math inline">\(\int_0^T \sigma_t^4 dt\)</span>.</p>
</section>
</section>
<section id="asymptotic-result" class="level3">
<h3 class="anchored" data-anchor-id="asymptotic-result">Asymptotic result</h3>
<p>A more detailed, but more technical, asymptotic analysis shown in [Zhang, Mykland and Aït-Sahalia]<sup id="cite_ref-ZMA" class="reference"><a href="#cite_note-ZMA">[9]</a></sup> yields that as <span class="math inline">\(n \to \infty\)</span></p>
<p><span class="math display">\[
[Y]^{\Pi}_T \mathop{\approx}^{\mathcal L} \angl{X}_T + 2 \, n \, \text{var}[\epsilon] + \sqrt{ 4 n \Eof{\epsilon^4} + \frac{2T}{n} \int_0^T \sigma_t^4 dt} \; Z,
\]</span></p>
<p>where <span class="math inline">\(Z \sim N(0,1)\)</span>.</p>
<section id="note-5" class="level4">
<h4 class="anchored" data-anchor-id="note-5">Note</h4>
<ul>
<li>The naive RV estimator <span class="math inline">\([Y]_T^\Pi\)</span> is biased by the variance of market microstructure noise <span class="math inline">\(\epsilon\)</span>. The biasedness increases as the sampling frequency <span class="math inline">\(n\)</span> increases.<br>
</li>
<li>We see that as <span class="math inline">\(n\to\infty\)</span>, the naive RV estimator <span class="math inline">\([Y]_T^\Pi\)</span> picks up mainly the microstructure noise.</li>
</ul>
</section>
</section>
<section id="the-conventional-solution" class="level3">
<h3 class="anchored" data-anchor-id="the-conventional-solution">The conventional solution</h3>
<ul>
<li><p>The conventional solution is to sample at most every five minutes or so.</p>
<ul>
<li>For high frequency data, sampling only every 5 minutes usually corresponds to throwing out more than 99% of the points!</li>
</ul></li>
<li><p>To quote [Zhang, Mykland and Aït-Sahalia]<sup id="cite_ref-ZMA" class="reference"><a href="#cite_note-ZMA">[9]</a></sup>, “It is difficult to accept that throwing away data, especially in such quantities, can be an optimal solution.”</p></li>
<li><p>From a more practical perspective, if we believe that volatility is time-varying, it makes sense to try and measure it from recent data over the last few minutes rather than from a whole day of trading.</p></li>
</ul>
</section>
<section id="subsampling" class="level3">
<h3 class="anchored" data-anchor-id="subsampling">Subsampling</h3>
<p>Let <span class="math inline">\(\Pi^{(k)} = \{0 \leq t_0^{(k)} &lt; \cdots &lt; t_{n_k}^{(k)}\leq T\}\)</span>, for <span class="math inline">\(1 \leq k \leq K\)</span>, be a collection of nonoverlapping subsampling times in <span class="math inline">\(\Pi\)</span>. That is,</p>
<p><span class="math display">\[
\bigcup_{k=1}^K \Pi^{(k)} = \Pi \quad \text{ and } \quad \Pi^{(k)} \cap \Pi^{(\ell)} = \emptyset \; \text{for } k \neq \ell.
\]</span></p>
<p>A typical example that we shall be using in the following is by sampling every <span class="math inline">\(K\)</span> ticks from the <span class="math inline">\(k\)</span>th tick on. That is,</p>
<span class="math display">\[\begin{aligned}
\Pi^{(1)} &amp;= \{t_1 &lt; t_{1+K} &lt; t_{1 + 2K} &lt; \cdots &lt; t_{1 + n_1 K} \leq T \}, \\
\Pi^{(2)} &amp;= \{t_2 &lt; t_{2+K} &lt; t_{2 + 2K}&lt; \cdots &lt; t_{2 + n_2 K} \leq T \}, \\
&amp;\quad \vdots \\
\Pi^{(K)} &amp;= \{t_0 &lt; t_K &lt; t_{2K} &lt; \cdots &lt; t_{n_K K} \leq T \}.
\end{aligned}\]</span>
<p>We denote by <span class="math inline">\([Y]_T^{\Pi^{(k)}}\)</span> the RV estimate of <span class="math inline">\(Y\)</span> using the subsamples that are sampled from the sampling times in <span class="math inline">\(\Pi^{(k)}\)</span>, for <span class="math inline">\(1 \leq k \leq K\)</span>.</p>
<p>By the same token, we have the following asymptotics for each subsample <span class="math inline">\(k \in \{1, \cdots, K\}\)</span></p>
<p><span class="math display">\[
[Y]^{\Pi^{(k)}}_T \mathop{\approx}^{\mathcal L} \angl{X}_T + 2 \, n_k \, \text{var}[\epsilon] + \sqrt{ 4 n_k \Eof{\epsilon^4} + \frac{2T}{n_k} \int_0^T \sigma_t^4 dt} \; Z_k
\]</span></p>
<p>where <span class="math inline">\(Z_k \sim N(0,1)\)</span>.</p>
</section>
<section id="boosting-rv-estimator" class="level3">
<h3 class="anchored" data-anchor-id="boosting-rv-estimator">Boosting RV estimator</h3>
<p>We can boost the RV estimator by averaging over the “weak learners” <span class="math inline">\([Y]_T^{\Pi^{(k)}}\)</span></p>
<span class="math display">\[\begin{aligned}
[Y]_T^{\text{avg}} &amp;= \frac{1}{K} \sum_{k=1}^K [Y]_T^{\Pi^{(k)}} \\
&amp;\approx \langle X \rangle_T + 2 \, \bar{n}_K \, \text{var}[\epsilon] + \sqrt{ 4 \frac{\bar{n}_K}{K} \E[\epsilon^4] + \frac{4T}{3 \bar{n}_K} \int_0^T \sigma_t^4 \, dt} \, Z.
\end{aligned}\]</span>
<p>where $n_K := 1K _k n_k $ is the average number of ticks in each subsample, roughly equal to <span class="math inline">\(\frac nK\)</span>.</p>
<section id="note-6" class="level4">
<h4 class="anchored" data-anchor-id="note-6">Note</h4>
<ul>
<li>Boosting reduces biasedness and variance by a factor of <span class="math inline">\(K\)</span>, but is unable to completely remove the biasedness.</li>
<li>The optimal average subsample size <span class="math inline">\(\bar n^*\)</span> is given by <span class="math display">\[
\bar n^* = \sqrt[3]{\frac T{6\text{var}^2[\epsilon]} \int_0^T \sigma_t^4 dt}.
\]</span></li>
</ul>
<p>Thus, the whole sample set is splitted into roughly <span class="math inline">\(K^* \approx \frac n{\bar n^*}\)</span> sets of subsamples.</p>
</section>
</section>
<section id="the-zma-estimator" class="level3">
<h3 class="anchored" data-anchor-id="the-zma-estimator">The ZMA estimator</h3>
<p>Recall that</p>
<span class="math display">\[\begin{aligned}
[Y]_T^\Pi &amp;\approx \langle X \rangle_T + n \, \text{var}[\epsilon], \\
[Y]_T^{\text{avg}} &amp;\approx \langle X \rangle_T + \bar{n}_K \, \text{var}[\epsilon].
\end{aligned}\]</span>
<p>We can eliminate bias by forming</p>
<span class="math display">\[\begin{aligned}
\frac{1}{\bar{n}_K}[Y]_T^{\text{avg}} - \frac{1}{n} [Y]_T^\Pi &amp;\approx \left( \frac{1}{\bar{n}_K} - \frac{1}{n} \right) \langle X \rangle_T.
\end{aligned}\]</span>
<p>Thus we obtain the [Zhang, Mykland and Aït-Sahalia]<sup id="cite_ref-ZMA" class="reference"><a href="#cite_note-ZMA">[9]</a></sup> (ZMA) bias-corrected estimator of <span class="math inline">\(\angl{X}_T\)</span>:</p>
<p><span class="math display">\[
[Y]_T^{ZMA} := \frac{1}{n - \bar n_K} \, \left\{n \, [Y]_T^{avg} - \bar n_K \, [Y]^\Pi_T \right\}.
\]</span></p>
<p>Moreover, we have the asymptotic behavior for <span class="math inline">\([Y]_T^{ZMA}\)</span> as</p>
<p><span class="math display">\[
[Y]_T^{ZMA} \approx \angl{X}_T + \frac1{\sqrt[6]n}\sqrt{\frac8{c^2}\text{var}^2[\epsilon] + c \frac{4T}3 \int_0^T \sigma_t^4 dt} \; Z
\]</span></p>
<p>where <span class="math inline">\(Z \sim N(0,1)\)</span>. The optimal constant <span class="math inline">\(c^*\)</span> is given by</p>
<p><span class="math display">\[
c^* = \left(\frac T{12 \, \text{var}^2[\epsilon]} \int_0^T \sigma_t^4 dt \right)^{-\frac13}.
\]</span></p>
<section id="note-7" class="level4">
<h4 class="anchored" data-anchor-id="note-7">Note</h4>
<p>In the original paper [Zhang, Mykland and Aït-Sahalia]<sup id="cite_ref-ZMA" class="reference"><a href="#cite_note-ZMA">[9]</a></sup>, the authors suggested the estimator as <span class="math inline">\([Y]_T^{avg} - \frac{\bar n_K}{n}[Y]_T^\Pi\)</span>, whereas the estimator <span class="math inline">\([Y]_T^{ZMA}\)</span> obtained above is referred to as the <em>small-sample adjustment</em> in the paper.</p>
</section>
</section>
<section id="the-zhou-estimator" class="level3">
<h3 class="anchored" data-anchor-id="the-zhou-estimator">The Zhou estimator</h3>
<p>Define</p>
<p><span class="math display">\[\begin{align}
[Y]_T^{\Pi, Z} &amp;: = \sum_{i=1}^n (\Delta Y_{t_i})^2 + \sum_{i=2}^n \Delta Y_{t_i} \Delta Y_{t_{i-1}} + \sum_{i=1}^{n-1} \Delta Y_{t_i} \Delta Y_{t_{i+1}} \\
&amp;= \sum_{i=1}^n (Y_{t_i} - Y_{t_{i-1}})(Y_{t_{i+1}} - Y_{t_{i-2}}).
\end{align}\]</span></p>
<p>Thus, under the assumption <span class="math inline">\(Y = X + \epsilon\)</span> of serially uncorrelated noise independent of returns <span class="math inline">\(X\)</span>, we obtain <span class="math inline">\(\mathbb{E}\left[[Y]^{\Pi, Z}\right] = \Eof{[X]_T}\)</span>.</p>
<p>By further assume <span class="math inline">\(X_t = \sigma W_{\tau(t)}\)</span> (a time-changed Brownian motion) for some Brownian motion <span class="math inline">\(W\)</span> and deterministic increasing function <span class="math inline">\(\tau(\cdot)\)</span>, since</p>
<p><span class="math display">\[
\Eof{(\Delta X_{t_i})^2} = \sigma^2 \Eof{\left\{ W_{\tau(t_i)} - W_{\tau(t_{i-1})} \right\}^2} = \sigma^2 \{\tau(t_i) - \tau(t_{i-1})\},
\]</span></p>
<p>we have</p>
<p><span class="math display">\[
\mathbb{E}\left[[Y]^{\Pi, Z}\right] = \sigma^2 \{\tau(T) - \tau(0) \} = \angl{X}_T.
\]</span></p>
<p>In other words, in this case <span class="math inline">\([Y]^{\Pi, Z}\)</span> is an unbiased estimator of <span class="math inline">\(\angl{X}_T\)</span>.</p>
</section>
</section>
<section id="realized-library" class="level2">
<h2 class="anchored" data-anchor-id="realized-library">Realized library</h2>
<p>Realized Library at Oxford-Man Institute of Quantitative Finance publishes daily realized variances/volatilities for various indices.</p>
<p><a href="https://realized.oxford-man.ox.ac.uk/">https://realized.oxford-man.ox.ac.uk/</a></p>
<section id="note-8" class="level4">
<h4 class="anchored" data-anchor-id="note-8">Note</h4>
<p><font color="blue">Unfortunately, the Realized Library has ceased providing the service.</font></p>
</section>
</section>
<section id="spx-realized-variance" class="level2">
<h2 class="anchored" data-anchor-id="spx-realized-variance">SPX realized variance</h2>
<div id="cell-136" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime <span class="im">as</span> dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-137" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'OxfordManRealizedVolatilityIndices.csv'</span>, index_col<span class="op">=</span><span class="dv">0</span>, header<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>rv1 <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>df.index)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col[<span class="op">-</span><span class="dv">3</span>:] <span class="op">==</span> <span class="st">'.rk'</span>:</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>        rv1[col] <span class="op">=</span> df[col]</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># convert index into datetime</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>rv1.index <span class="op">=</span> [dt.strptime(<span class="bu">str</span>(date), <span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">"</span>) <span class="cf">for</span> date <span class="kw">in</span> rv1.index.values]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-138" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SPX2.rv</th>
<th data-quarto-table-cell-role="th">SPX2.rk</th>
<th data-quarto-table-cell-role="th">SPX2.r</th>
<th data-quarto-table-cell-role="th">SPX2.rv5ss</th>
<th data-quarto-table-cell-role="th">SPX2.rv10</th>
<th data-quarto-table-cell-role="th">SPX2.rv10ss</th>
<th data-quarto-table-cell-role="th">SPX2.bv5</th>
<th data-quarto-table-cell-role="th">SPX2.bv5ss</th>
<th data-quarto-table-cell-role="th">SPX2.medrv</th>
<th data-quarto-table-cell-role="th">SPX2.rs</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FTSEMIB.rs</th>
<th data-quarto-table-cell-role="th">FTSEMIB.rs5ss</th>
<th data-quarto-table-cell-role="th">FTSEMIB.nobs</th>
<th data-quarto-table-cell-role="th">FTSEMIB.timespan</th>
<th data-quarto-table-cell-role="th">FTSEMIB.rcto</th>
<th data-quarto-table-cell-role="th">FTSEMIB.open</th>
<th data-quarto-table-cell-role="th">FTSEMIB.highlow</th>
<th data-quarto-table-cell-role="th">FTSEMIB.highopen</th>
<th data-quarto-table-cell-role="th">FTSEMIB.openprice</th>
<th data-quarto-table-cell-role="th">FTSEMIB.closeprice</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DateID</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000103</td>
<td>0.000157</td>
<td>0.000161</td>
<td>-0.010104</td>
<td>0.000144</td>
<td>0.000175</td>
<td>0.000170</td>
<td>0.000157</td>
<td>0.000142</td>
<td>0.000084</td>
<td>0.000099</td>
<td>...</td>
<td>0.000323</td>
<td>0.000314</td>
<td>496.0</td>
<td>29752.752</td>
<td>NaN</td>
<td>34152.212</td>
<td>0.061739</td>
<td>0.002525</td>
<td>43900.00</td>
<td>41477.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000104</td>
<td>0.000298</td>
<td>0.000264</td>
<td>-0.039292</td>
<td>0.000219</td>
<td>0.000400</td>
<td>0.000247</td>
<td>0.000206</td>
<td>0.000206</td>
<td>0.000092</td>
<td>0.000254</td>
<td>...</td>
<td>0.000144</td>
<td>0.000173</td>
<td>471.0</td>
<td>28319.096</td>
<td>NaN</td>
<td>35524.926</td>
<td>0.020667</td>
<td>0.001046</td>
<td>41072.00</td>
<td>40468.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000105</td>
<td>0.000307</td>
<td>0.000305</td>
<td>0.001749</td>
<td>0.000298</td>
<td>0.000258</td>
<td>0.000307</td>
<td>0.000292</td>
<td>0.000279</td>
<td>0.000111</td>
<td>0.000138</td>
<td>...</td>
<td>0.000144</td>
<td>0.000153</td>
<td>497.0</td>
<td>29751.621</td>
<td>NaN</td>
<td>34154.433</td>
<td>-0.029584</td>
<td>0.029584</td>
<td>39000.00</td>
<td>39449.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20000106</td>
<td>0.000136</td>
<td>0.000149</td>
<td>0.001062</td>
<td>0.000136</td>
<td>0.000108</td>
<td>0.000133</td>
<td>0.000127</td>
<td>0.000127</td>
<td>0.000086</td>
<td>0.000062</td>
<td>...</td>
<td>0.000196</td>
<td>0.000216</td>
<td>496.0</td>
<td>29691.265</td>
<td>NaN</td>
<td>34154.335</td>
<td>0.032678</td>
<td>0.000276</td>
<td>39834.00</td>
<td>38736.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20000107</td>
<td>0.000093</td>
<td>0.000123</td>
<td>0.026022</td>
<td>0.000112</td>
<td>0.000121</td>
<td>0.000114</td>
<td>0.000083</td>
<td>0.000095</td>
<td>0.000049</td>
<td>0.000024</td>
<td>...</td>
<td>0.000072</td>
<td>0.000081</td>
<td>497.0</td>
<td>29751.482</td>
<td>NaN</td>
<td>34153.093</td>
<td>-0.027410</td>
<td>0.026694</td>
<td>39144.00</td>
<td>40199.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20171129</td>
<td>0.000016</td>
<td>0.000017</td>
<td>-0.000693</td>
<td>0.000017</td>
<td>0.000016</td>
<td>0.000016</td>
<td>0.000012</td>
<td>0.000013</td>
<td>0.000019</td>
<td>0.000009</td>
<td>...</td>
<td>0.000030</td>
<td>0.000025</td>
<td>19553.0</td>
<td>27358.791</td>
<td>NaN</td>
<td>32401.219</td>
<td>0.010438</td>
<td>0.005222</td>
<td>22391.37</td>
<td>22325.94</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20171130</td>
<td>0.000028</td>
<td>0.000020</td>
<td>0.004886</td>
<td>0.000023</td>
<td>0.000035</td>
<td>0.000025</td>
<td>0.000024</td>
<td>0.000024</td>
<td>0.000018</td>
<td>0.000010</td>
<td>...</td>
<td>0.000021</td>
<td>0.000024</td>
<td>23672.0</td>
<td>27357.591</td>
<td>NaN</td>
<td>32402.862</td>
<td>0.008467</td>
<td>0.004035</td>
<td>22467.64</td>
<td>22368.29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20171201</td>
<td>0.000088</td>
<td>0.000130</td>
<td>-0.001256</td>
<td>0.000117</td>
<td>0.000120</td>
<td>0.000124</td>
<td>0.000093</td>
<td>0.000126</td>
<td>0.000138</td>
<td>0.000061</td>
<td>...</td>
<td>0.000047</td>
<td>0.000054</td>
<td>25521.0</td>
<td>27359.230</td>
<td>NaN</td>
<td>32400.969</td>
<td>-0.013862</td>
<td>0.008983</td>
<td>22168.37</td>
<td>22106.10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20171204</td>
<td>0.000023</td>
<td>0.000023</td>
<td>-0.006854</td>
<td>0.000021</td>
<td>0.000022</td>
<td>0.000020</td>
<td>0.000024</td>
<td>0.000022</td>
<td>0.000020</td>
<td>0.000014</td>
<td>...</td>
<td>0.000015</td>
<td>0.000015</td>
<td>21585.0</td>
<td>27359.204</td>
<td>NaN</td>
<td>32400.856</td>
<td>0.006576</td>
<td>0.003166</td>
<td>22350.63</td>
<td>22362.11</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20171205</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>4683 rows × 399 columns</p>
</div>
</div>
</div>
<div id="cell-139" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>rv1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SPX2.rk</th>
<th data-quarto-table-cell-role="th">FTSE2.rk</th>
<th data-quarto-table-cell-role="th">N2252.rk</th>
<th data-quarto-table-cell-role="th">GDAXI2.rk</th>
<th data-quarto-table-cell-role="th">RUT2.rk</th>
<th data-quarto-table-cell-role="th">AORD2.rk</th>
<th data-quarto-table-cell-role="th">DJI2.rk</th>
<th data-quarto-table-cell-role="th">IXIC2.rk</th>
<th data-quarto-table-cell-role="th">FCHI2.rk</th>
<th data-quarto-table-cell-role="th">HSI2.rk</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">AEX.rk</th>
<th data-quarto-table-cell-role="th">SSMI.rk</th>
<th data-quarto-table-cell-role="th">IBEX2.rk</th>
<th data-quarto-table-cell-role="th">NSEI.rk</th>
<th data-quarto-table-cell-role="th">MXX.rk</th>
<th data-quarto-table-cell-role="th">BVSP.rk</th>
<th data-quarto-table-cell-role="th">GSPTSE.rk</th>
<th data-quarto-table-cell-role="th">STOXX50E.rk</th>
<th data-quarto-table-cell-role="th">FTSTI.rk</th>
<th data-quarto-table-cell-role="th">FTSEMIB.rk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>0.000161</td>
<td>NaN</td>
<td>NaN</td>
<td>0.000702</td>
<td>0.000264</td>
<td>NaN</td>
<td>0.000135</td>
<td>0.000574</td>
<td>0.000262</td>
<td>0.000261</td>
<td>...</td>
<td>0.000124</td>
<td>NaN</td>
<td>0.000168</td>
<td>NaN</td>
<td>0.000088</td>
<td>0.000404</td>
<td>NaN</td>
<td>0.000272</td>
<td>0.000158</td>
<td>0.000520</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>0.000264</td>
<td>0.000249</td>
<td>0.000162</td>
<td>0.000591</td>
<td>0.000232</td>
<td>0.000045</td>
<td>0.000159</td>
<td>0.000575</td>
<td>0.000372</td>
<td>0.000207</td>
<td>...</td>
<td>0.000233</td>
<td>0.000102</td>
<td>0.000215</td>
<td>NaN</td>
<td>0.000214</td>
<td>0.000617</td>
<td>NaN</td>
<td>0.000252</td>
<td>0.000123</td>
<td>0.000336</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>0.000305</td>
<td>0.000198</td>
<td>0.000245</td>
<td>0.001081</td>
<td>0.000145</td>
<td>0.000256</td>
<td>0.000196</td>
<td>0.000941</td>
<td>0.000334</td>
<td>0.001597</td>
<td>...</td>
<td>0.000448</td>
<td>0.000123</td>
<td>0.000292</td>
<td>NaN</td>
<td>0.000173</td>
<td>0.000982</td>
<td>NaN</td>
<td>0.000506</td>
<td>0.000394</td>
<td>0.000422</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-06</td>
<td>0.000149</td>
<td>0.000148</td>
<td>0.000198</td>
<td>0.000306</td>
<td>0.000056</td>
<td>0.000031</td>
<td>0.000124</td>
<td>0.000580</td>
<td>0.000248</td>
<td>0.000870</td>
<td>...</td>
<td>0.000224</td>
<td>0.000087</td>
<td>NaN</td>
<td>0.000030</td>
<td>0.000056</td>
<td>0.000501</td>
<td>NaN</td>
<td>0.000110</td>
<td>0.000586</td>
<td>0.000339</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-07</td>
<td>0.000123</td>
<td>0.000126</td>
<td>0.000157</td>
<td>0.000301</td>
<td>0.000031</td>
<td>0.000043</td>
<td>0.000096</td>
<td>0.000396</td>
<td>0.000257</td>
<td>0.000508</td>
<td>...</td>
<td>0.000107</td>
<td>0.000066</td>
<td>0.000155</td>
<td>0.000039</td>
<td>0.000082</td>
<td>0.000258</td>
<td>NaN</td>
<td>0.000149</td>
<td>0.000159</td>
<td>0.000160</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017-11-29</td>
<td>0.000017</td>
<td>0.000018</td>
<td>0.000025</td>
<td>0.000047</td>
<td>0.000037</td>
<td>0.000016</td>
<td>0.000012</td>
<td>0.000066</td>
<td>0.000030</td>
<td>0.000039</td>
<td>...</td>
<td>0.000034</td>
<td>0.000021</td>
<td>0.000056</td>
<td>0.000009</td>
<td>0.000035</td>
<td>0.000123</td>
<td>0.000019</td>
<td>0.000040</td>
<td>NaN</td>
<td>0.000029</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2017-11-30</td>
<td>0.000020</td>
<td>0.000020</td>
<td>0.000038</td>
<td>0.000058</td>
<td>0.000035</td>
<td>0.000031</td>
<td>0.000026</td>
<td>0.000039</td>
<td>0.000040</td>
<td>0.000040</td>
<td>...</td>
<td>0.000036</td>
<td>0.000033</td>
<td>0.000066</td>
<td>0.000025</td>
<td>0.000042</td>
<td>0.000114</td>
<td>0.000016</td>
<td>0.000044</td>
<td>NaN</td>
<td>0.000033</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017-12-01</td>
<td>0.000130</td>
<td>0.000041</td>
<td>0.000066</td>
<td>0.000142</td>
<td>0.000208</td>
<td>0.000017</td>
<td>0.000153</td>
<td>0.000126</td>
<td>0.000110</td>
<td>0.000066</td>
<td>...</td>
<td>0.000092</td>
<td>0.000056</td>
<td>0.000090</td>
<td>0.000026</td>
<td>0.000061</td>
<td>0.000151</td>
<td>0.000034</td>
<td>0.000117</td>
<td>NaN</td>
<td>0.000073</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2017-12-04</td>
<td>0.000023</td>
<td>0.000027</td>
<td>0.000039</td>
<td>0.000050</td>
<td>0.000104</td>
<td>0.000009</td>
<td>0.000024</td>
<td>0.000060</td>
<td>0.000028</td>
<td>0.000082</td>
<td>...</td>
<td>0.000028</td>
<td>0.000026</td>
<td>0.000048</td>
<td>0.000031</td>
<td>0.000050</td>
<td>0.000092</td>
<td>0.000012</td>
<td>0.000064</td>
<td>NaN</td>
<td>0.000029</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017-12-05</td>
<td>NaN</td>
<td>0.000019</td>
<td>0.000027</td>
<td>0.000059</td>
<td>0.000025</td>
<td>0.000018</td>
<td>0.000023</td>
<td>0.000046</td>
<td>0.000037</td>
<td>0.000044</td>
<td>...</td>
<td>0.000026</td>
<td>0.000028</td>
<td>0.000043</td>
<td>0.000026</td>
<td>0.000045</td>
<td>0.000139</td>
<td>0.000009</td>
<td>0.000039</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>4683 rows × 21 columns</p>
</div>
</div>
</div>
<div id="cell-140" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot spx realized variance</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># spx2.rk contains the rv calcuated by the realized kernel within 5-min bins</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>spx_rv <span class="op">=</span> pd.DataFrame(rv1[<span class="st">'SPX2.rk'</span>])</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>spx_rv.plot(color<span class="op">=</span><span class="st">'red'</span>, grid<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span><span class="st">'SPX realized variance'</span>,</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>         figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), ylim<span class="op">=</span>(<span class="dv">0</span>,<span class="fl">0.003</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-84-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-corsi-har-rv-forecast" class="level2">
<h2 class="anchored" data-anchor-id="the-corsi-har-rv-forecast">The Corsi HAR-RV forecast</h2>
<ul>
<li><p>The Corsi HAR-RV model implements a regression to fit the parameters.</p></li>
<li><p>This model can be regarded as a poor man’s version of a long memory model such as ARFIMA.</p>
<ul>
<li>True long-memory models such as ARFIMA are notoriously hard to fit.</li>
</ul></li>
<li><p>HAR-RV can also be considered an intelligent alternative to GARCH.</p></li>
<li><p>The model boils down to the regression</p>
<p><span class="math display">\[RV_{t,t+h} = \beta_0 + \beta_D\,RV_t + \beta_W\,RV_{t-5,t} + \beta_M\,RV_{t-22,t} + \epsilon_{t,t+h}.\]</span></p>
<p>In words, the RV forecast for <span class="math inline">\(h\)</span> days from now is a linear combination of the current realized variance and (aggregate) RV estimates for the last week and the last month.</p></li>
</ul>
<section id="note-9" class="level3">
<h3 class="anchored" data-anchor-id="note-9">Note</h3>
<ul>
<li><span class="math inline">\(RV\)</span> denotes the logarithm of realized variance.</li>
</ul>
<div id="cell-142" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-143" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take h = 1 in the HAR-RV model</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># y = RV_{t+h}</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rv1 = RV_t</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rv5 = RV_{t-5}</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rv22 = RV_{t-22}</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>spx_rv <span class="op">=</span> spx_rv.dropna()</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>spx1 <span class="op">=</span> np.array(spx_rv)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> spx1[<span class="dv">22</span>:]</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>rv1 <span class="op">=</span> spx1[<span class="dv">21</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>rv5 <span class="op">=</span> np.array(pd.DataFrame(spx1[<span class="dv">17</span>:]).rolling(<span class="dv">5</span>).mean()[<span class="dv">5</span><span class="op">-</span><span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>rv22 <span class="op">=</span> np.array(pd.DataFrame(spx1[:]).rolling(<span class="dv">22</span>).mean()[<span class="dv">22</span><span class="op">-</span><span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-144" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># regress y over rv1 + rv5 + rv22</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">'y'</span>: y, <span class="st">'rv1'</span>: rv1, <span class="st">'rv5'</span>: rv5, <span class="st">'rv22'</span>: rv22}</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>fit_har <span class="op">=</span> sm.ols(<span class="st">'y ~ rv1 + rv5 + rv22'</span>, data<span class="op">=</span>data).fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-145" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fit_har.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.506
Model:                            OLS   Adj. R-squared:                  0.506
Method:                 Least Squares   F-statistic:                     1523.
Date:                Thu, 24 Jul 2025   Prob (F-statistic):               0.00
Time:                        14:55:45   Log-Likelihood:                 32207.
No. Observations:                4459   AIC:                        -6.441e+04
Df Residuals:                    4455   BIC:                        -6.438e+04
Df Model:                           3                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept   1.046e-05   3.07e-06      3.403      0.001    4.43e-06    1.65e-05
rv1            0.2250      0.018     12.458      0.000       0.190       0.260
rv5            0.4543      0.031     14.870      0.000       0.394       0.514
rv22           0.2221      0.027      8.078      0.000       0.168       0.276
==============================================================================
Omnibus:                    10266.653   Durbin-Watson:                   2.045
Prob(Omnibus):                  0.000   Jarque-Bera (JB):        167121903.379
Skew:                          21.714   Prob(JB):                         0.00
Kurtosis:                     950.431   Cond. No.                     1.47e+04
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[2] The condition number is large, 1.47e+04. This might indicate that there are
strong multicollinearity or other numerical problems.</code></pre>
</div>
</div>
<div id="cell-146" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>fit_har.params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>Intercept    0.000010
rv1          0.225020
rv5          0.454300
rv22         0.222093
dtype: float64</code></pre>
</div>
</div>
<div id="cell-147" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert fitted values into pd.DataFrame</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> pd.DataFrame({<span class="st">'fitted'</span>: np.array(fit_har.fittedvalues)}, index<span class="op">=</span>spx_rv[<span class="dv">22</span>:].index)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>fitted.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fitted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-02-03</td>
<td>0.000159</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-02-04</td>
<td>0.000166</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-02-07</td>
<td>0.000124</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-02-08</td>
<td>0.000105</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-02-09</td>
<td>0.000108</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-148" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># log plot</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>plt.plot(spx_rv, color<span class="op">=</span><span class="st">'red'</span>, ls<span class="op">=</span><span class="st">'dotted'</span>, label<span class="op">=</span><span class="st">'Observed RV'</span>)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>plt.plot(fitted, <span class="st">'b'</span>, label<span class="op">=</span><span class="st">'Forecasted RV'</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Observed and forecasted RV based on HAR model'</span>, fontsize<span class="op">=</span><span class="dv">20</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="NSD_Lec05-Volatility_Summer2025_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<p><br></p>
<div class="reflist" style="list-style-type: decimal;">
<ol>
<li id="cite_note-Corsi">
<span class="mw-cite-backlink"><b><a href="#cite_ref-Corsi">^</a></b></span>Fulvio Corsi, A simple approximate long-memory model of realized volatility, <span><em>Journal of Financial Econometrics</em></span> <span><strong>7</strong></span>(2) 174–196 (2009).
</li>
<li id="cite_note-ZMA">
<span class="mw-cite-backlink"><b><a href="#cite_ref-ZMA">^</a></b></span>Lan Zhang, Per A. Mykland and Yacine Aït-Sahalia, A tale of two time scales: Determining intergrated volatility with noise high-frequency data, <span><em>Journal of the American Statistical Association</em></span>, <span><strong>100</strong></span>(472), 1394–1411 (2005).
</li>
<li id="cite_note-Zhou">
<span class="mw-cite-backlink"><b><a href="#cite_ref-Zhou">^</a></b></span>Bin Zhou, High-frequency data and volatility in foreign-exchange rates, <span><em>Journal of Business &amp; Economic Statistics</em></span>, <span><strong>14</strong></span>(1), 45–52 (1996).
</li>
</ol>


</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>